<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Web ƒê√°nh Gi√° Checklist</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f8fa; margin: 0; padding: 30px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    h2 { color: #333; margin-top: 0; }
    h3 { color: #4caf50; margin-top: 30px; }
    label { display: block; margin: 8px 0; }
    select, button, #datePicker { padding: 8px 12px; font-size: 16px; margin-bottom: 10px; }
    #datePicker { border: 1px solid #ccc; border-radius: 8px; font-family: 'Segoe UI', Roboto, sans-serif; background-repeat: no-repeat; background-position: right 10px center; background-size: 16px 16px; padding-right: 32px; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E"); }
    #datePicker:hover, #datePicker:focus { border-color: #4CAFEF; outline: none; }
button { background-color: #4caf50; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #43a047; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #c8e6c9; }
    .result { margin-top: 20px; font-size: 18px; font-weight: bold; }
    .hidden { display: none; }
    label.checked { background-color: #e0ffe0; color: #2e7d32; animation: fade-in 0.3s; }
    .flatpickr-day.complete { background-color: #b2f2bb; color: #000; }
    .flatpickr-day.incomplete { background-color: #ffe6e6; color: #000; }
    #compareChart { max-height: 300px; }
    .progress { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    .progress div { height: 100%; background-color: #4caf50; text-align: center; color: #fff; line-height: 20px; font-weight: bold; }
    .actions { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .date-picker { padding: 8px; border: 1px solid #ccc; border-radius: 8px; transition: border-color 0.2s; }
    .date-picker:hover, .date-picker:focus { border-color: #4CAFEF; outline: none; }
    .action-btn { background-color: #4CAF50; color: #fff; padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; margin-right: 8px; }
    .action-btn:hover { background-color: #43A047; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
    .actions .action-btn:last-child { margin-right: 0; }
    .bars { display: flex; gap: 10px; margin-bottom: 20px; }
    .bar { flex: 1; background: #eee; border-radius: 6px; position: relative; height: 24px; margin: 0 5px; }
    .bar span { position: absolute; left: 8px; top: 0; font-size: 12px; color: #000; line-height: 24px; z-index: 2; }
    .fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
    #energyBar { background: #FFD700; }
    #moodBar { background: #4DB6E2; }
    #auraBar { background: #B388EB; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <h2>ƒê√°nh Gi√° Checklist C√° Nh√¢n</h2>
    <div class="bars">
      <div class="bar"><span>Energy ‚ö°</span><div class="fill" id="energyBar"></div></div>
      <div class="bar"><span>Mood üòä</span><div class="fill" id="moodBar"></div></div>
      <div class="bar"><span>Aura ‚ú®</span><div class="fill" id="auraBar"></div></div>
    </div>
    <label for="category">Ch·ªçn nh√≥m checklist:</label>
    <select id="category" multiple>
      <option value="">-- Ch·ªçn nh√≥m --</option>
      <option value="chamCoThe">1. üèãÔ∏è ChƒÉm C∆° Th·ªÉ</option>
      <option value="chamNhaCua">2. üè† ChƒÉm Nh√† C·ª≠a</option>
      <option value="dinhDuong">3. üçé Dinh D∆∞·ª°ng ‚Äì ·∫®m Th·ª±c</option>
      <option value="langPhi">4. üí∞ Ki·ªÉm So√°t L√£ng Ph√≠</option>
      <option value="aura">5. ‚ú® N√¢ng T·∫ßng Aura</option>
      <option value="soThich">6. üé≠ S·ªü Th√≠ch ‚Äì D∆∞·ª°ng Kh√≠</option>
      <option value="theDuc">7. üèÉ Th·ªÉ D·ª•c ‚Äì C∆° X∆∞∆°ng ‚Äì D√°ng Form</option>
    </select>
    <canvas id="compareChart" class="hidden" style="margin-top:32px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(76,175,80,0.08);"></canvas>
    <div id="progressContainer" class="progress hidden"><div id="progressBar"></div></div>
    <div class="actions">
      <input type="text" id="datePicker" class="date-picker" readonly />
      <button class="action-btn" onclick="triggerImport()">Nh·∫≠p d·ªØ li·ªáu</button>
      <input type="file" id="import-file" accept=".json" class="hidden" />
      <button class="action-btn" onclick="undoChange()">Ho√†n t√°c</button>
    </div>
    <h3 id="checklist-title"></h3>
    <form id="checklist-form"></form>
    <div class="result checklist-summary">
      <div style="display:none"><span id="date"></span></div>
      <div><strong>ƒê√£ ho√†n th√†nh:</strong> <span id="count">0</span>/<span id="total">0</span></div>
      <!-- <div><strong>X·∫øp lo·∫°i:</strong> <span id="rank" class="grade">Ch∆∞a x√°c ƒë·ªãnh</span></div> -->
    </div>
    <!-- ƒê∆∞a snippet l√™n ngay d∆∞·ªõi checklist-form, th√™m hi·ªáu ·ª©ng ƒë·∫πp -->
    <div id="snippet" class="snippet" style="margin-top:20px; min-height:32px; font-size:18px; color:#4caf50; font-weight:bold; text-align:center; transition: all 0.3s;"></div>
    <!-- ƒê·ªông l·ª±c n·ªïi b·∫≠t, hi·ªáu ·ª©ng th√†nh t·ª±u ƒê∆ØA XU·ªêNG D∆Ø·ªöI C√ôNG -->
    <div id="motivationBox" style="margin:40px 0 0 0; text-align:center;">
      <span id="motivation" style="display:inline-block; background:linear-gradient(90deg,#e0ffe0,#b2f2bb,#e0ffe0); color:#1b5e20; font-size:26px; font-weight:bold; border-radius:16px; padding:18px 40px; box-shadow:0 2px 16px rgba(76,175,80,0.12); letter-spacing:1.5px; transition:all 0.3s; border:2px solid #43a047;"></span>
    </div>
    <!-- ƒê∆∞a story box xu·ªëng d∆∞·ªõi c√πng -->
    <div id="storyBox" style="display:none"><div id="storyMessages"></div></div>
    <!-- Modal th√†nh t·ª±u ƒë·∫πp h∆°n -->
    <div id="milestoneModal" class="modal hidden" style="z-index:9999;">
      <div class="modal-content" style="text-align:center; padding:32px 24px; border-radius:16px; background:#fff; box-shadow:0 4px 32px rgba(76,175,80,0.15);">
        <div class="icon" style="font-size:48px; margin-bottom:12px;">üéâ</div>
        <p id="milestoneText" style="font-size:22px; color:#388e3c; font-weight:bold; margin-bottom:16px;"></p>
        <button id="closeModal" style="background:#4caf50; color:#fff; border:none; border-radius:8px; padding:8px 24px; font-size:16px; cursor:pointer;">ƒê√≥ng</button>
        <div id="milestoneStoryMessages"></div>
      </div>
    </div>
   
    <script>
// --- D·ªØ li·ªáu checklist cho t·ª´ng nh√≥m ---
const checklistData = {
  chamCoThe: [
    "1‚Äì2 b·ªØa ph·ª• nh·∫π: s·ªØa h·∫°t / tr√°i c√¢y / h·∫°t mix",
    "1 b·ªØa c√≥ rau xanh d·∫°ng l√° (gi√∫p ti√™u h√≥a)",
    "1‚Äì2 b·ªØa c√≥ tr√°i c√¢y t∆∞∆°i",
    "1 b·ªØa c√≥ protein tr·∫Øng (c√°, g√†, tr·ª©ng)",
    "Tr√°nh ƒë·ªÉ qu√° 6 ti·∫øng kh√¥ng ƒÉn",
    "Kh√¥ng ƒÉn khuya sau 9h t·ªëi (tr·ª´ khi t·∫≠p n·∫∑ng)"
  ],
  chamNhaCua: [
    "Qu√©t d·ªçn nh√† c·ª≠a",
    "Lau ch√πi b·∫øp, b√†n, gh·∫ø",
    "S·∫Øp x·∫øp l·∫°i ƒë·ªì ƒë·∫°c g·ªçn g√†ng",
    "T∆∞·ªõi c√¢y, chƒÉm c√¢y c·∫£nh"
  ],
  dinhDuong: [
    "ƒÇn s√°ng ƒë·ªß ch·∫•t",
    "U·ªëng ƒë·ªß n∆∞·ªõc trong ng√†y",
    "ƒÇn tr√°i c√¢y ho·∫∑c rau xanh",
    "H·∫°n ch·∫ø ƒë·ªì ng·ªçt, n∆∞·ªõc ng·ªçt"
  ],
  langPhi: [
    "Kh√¥ng mua ƒë·ªì kh√¥ng c·∫ßn thi·∫øt",
    "Kh√¥ng ti√™u ti·ªÅn cho th√≥i quen x·∫•u",
    "Ki·ªÉm tra v√≠ tr∆∞·ªõc khi ra ngo√†i",
    "Ghi ch√∫ chi ti√™u trong ng√†y"
  ],
  aura: [
    "Thi·ªÅn ho·∫∑c th·ªü s√¢u 5 ph√∫t",
    "ƒê·ªçc s√°ch ph√°t tri·ªÉn b·∫£n th√¢n",
    "Vi·∫øt nh·∫≠t k√Ω c·∫£m x√∫c",
    "Nghe nh·∫°c th∆∞ gi√£n"
  ],
  soThich: [
    "V·∫Ω/trang tr√≠/vi·∫øt l√°ch",
    "Ch∆°i nh·∫°c c·ª• ho·∫∑c nghe nh·∫°c",
    "T·∫≠p th·ªÉ thao nh·∫π nh√†ng",
    "ChƒÉm s√≥c c√¢y c·∫£nh/th√∫ c∆∞ng"
  ],
  theDuc: [
    "Kh·ªüi ƒë·ªông 5 ph√∫t",
    "T·∫≠p th·ªÉ d·ª•c √≠t nh·∫•t 15 ph√∫t",
    "ƒêi b·ªô 5000 b∆∞·ªõc tr·ªü l√™n",
    "Gi√£n c∆° sau t·∫≠p"
  ]
};
// --- H√†m l·∫•y ng√†y h√¥m nay d·∫°ng dd/mm/yyyy ---
function getTodayStr() {
  const d = new Date();
  return d.getDate().toString().padStart(2, '0') + '/' +
         (d.getMonth() + 1).toString().padStart(2, '0') + '/' +
         d.getFullYear();
}
 const checklistValues = {
  "1‚Äì2 b·ªØa ph·ª• nh·∫π: s·ªØa h·∫°t / tr√°i c√¢y / h·∫°t mix": { energy: 2, mood: 2, aura: 1 },
  "1 b·ªØa c√≥ rau xanh d·∫°ng l√° (gi√∫p ti√™u h√≥a)": { energy: 2, mood: 1, aura: 1 },
  "1‚Äì2 b·ªØa c√≥ tr√°i c√¢y t∆∞∆°i": { energy: 2, mood: 2, aura: 1 },
  "1 b·ªØa c√≥ protein tr·∫Øng (c√°, g√†, tr·ª©ng)": { energy: 3, mood: 1, aura: 1 },
  "Tr√°nh ƒë·ªÉ qu√° 6 ti·∫øng kh√¥ng ƒÉn": { energy: 1, mood: 1, aura: 1 },
  "Kh√¥ng ƒÉn khuya sau 9h t·ªëi (tr·ª´ khi t·∫≠p n·∫∑ng)": { energy: 2, mood: 1, aura: 1 },
  // Ki·ªÉm so√°t l√£ng ph√≠
  "Kh√¥ng mua ƒë·ªì kh√¥ng c·∫ßn thi·∫øt": { energy: 0, mood: 0, aura: 5 },
  "Kh√¥ng ti√™u ti·ªÅn cho th√≥i quen x·∫•u": { energy: 0, mood: 0, aura: 5 },
  "Ki·ªÉm tra v√≠ tr∆∞·ªõc khi ra ngo√†i": { energy: 0, mood: 0, aura: 2 },
  "Ghi ch√∫ chi ti√™u trong ng√†y": { energy: 0, mood: 0, aura: 3 },
  // Aura
  "Thi·ªÅn ho·∫∑c th·ªü s√¢u 5 ph√∫t": { energy: 0, mood: 5, aura: 5 },
  "ƒê·ªçc s√°ch ph√°t tri·ªÉn b·∫£n th√¢n": { energy: 0, mood: 3, aura: 5 },
  "Vi·∫øt nh·∫≠t k√Ω c·∫£m x√∫c": { energy: 0, mood: 4, aura: 4 },
  "Nghe nh·∫°c th∆∞ gi√£n": { energy: 0, mood: 5, aura: 3 },
  // S·ªü th√≠ch
  "V·∫Ω/trang tr√≠/vi·∫øt l√°ch": { energy: 0, mood: 4, aura: 4 },
  "Ch∆°i nh·∫°c c·ª• ho·∫∑c nghe nh·∫°c": { energy: 0, mood: 5, aura: 3 },
  "T·∫≠p th·ªÉ thao nh·∫π nh√†ng": { energy: 0, mood: 3, aura: 2 },
  "ChƒÉm s√≥c c√¢y c·∫£nh/th√∫ c∆∞ng": { energy: 0, mood: 4, aura: 3 },
  // Th·ªÉ d·ª•c
  "Kh·ªüi ƒë·ªông 5 ph√∫t": { energy: 5, mood: 0, aura: 0 },
  "T·∫≠p th·ªÉ d·ª•c √≠t nh·∫•t 15 ph√∫t": { energy: 10, mood: 0, aura: 0 },
  "ƒêi b·ªô 5000 b∆∞·ªõc tr·ªü l√™n": { energy: 8, mood: 0, aura: 0 },
  "Gi√£n c∆° sau t·∫≠p": { energy: 2, mood: 0, aura: 0 }
};

const storyBank = [
  "M·ªôt l√†n kh√≠ nh·∫π lan ra quanh b·∫°n.",
  "B·∫°n th·∫•y c∆° th·ªÉ m√¨nh ·∫•m l√™n m·ªôt ch√∫t.",
  "B·∫°n c·∫£m th·∫•y tinh th·∫ßn ph·∫•n ch·∫•n h∆°n.",
  "B·∫°n v·ª´a ho√†n th√†nh m·ªôt b∆∞·ªõc nh·ªè cho b·∫£n th√¢n.",
  "B·∫°n ƒë√£ chƒÉm s√≥c t·ªët cho ch√≠nh m√¨nh h√¥m nay."
];
const milestoneBank = [
  "C∆° th·ªÉ n√†y nh∆∞ v·ª´a ƒë∆∞·ª£c reset.",
  "CƒÉn ph√≤ng n√†y gi·ªù th·ªü c√πng b·∫°n.",
  "B·∫°n ƒë√£ ƒë·∫°t m·ªôt c·ªôt m·ªëc m·ªõi!",
  "B·∫°n x·ª©ng ƒë√°ng v·ªõi th√†nh t·ª±u n√†y!"
];

// --- Bi·∫øn to√†n c·ª•c ---
let selectedGroups = [];
let currentGroup = "";
let choicesInstance;
let compareChart;
const categorySelect = document.getElementById('category');

// --- Thanh tr·∫°ng th√°i ---
// --- T√≠nh l·∫°i t·ªïng ƒëi·ªÉm energy, mood, aura cho nh√≥m hi·ªán t·∫°i ---
function recalcStatsForCurrentGroup() {
  stats.energy = 0;
  stats.mood = 0;
  stats.aura = 0;
  if (!currentGroup || !checklistData[currentGroup]) {
    updateBars();
    saveStats();
    return;
  }
  const items = checklistData[currentGroup];
  const values = JSON.parse(localStorage.getItem('progress_' + currentGroup) || '[]');
  for (let i = 0; i < items.length; i++) {
    if (values[i]) {
      const val = checklistValues[items[i]] || { energy: 0, mood: 0, aura: 0 };
      stats.energy += val.energy;
      stats.mood += val.mood;
      stats.aura += val.aura;
    }
  }
  updateBars();
  saveStats();
}
const stats = { energy: 0, mood: 0, aura: 0 };
let statsDate = ""; // ng√†y hi·ªán t·∫°i c·ªßa thanh bar

function loadStats() {
  // L·∫•y tr·∫°ng th√°i thanh bar t·ª´ localStorage
  const saved = JSON.parse(localStorage.getItem('simStats') || '{}');
  if (saved && saved.date === getTodayStr()) {
    stats.energy = saved.energy || 0;
    stats.mood = saved.mood || 0;
    stats.aura = saved.aura || 0;
    statsDate = saved.date;
  } else {
    stats.energy = 0;
    stats.mood = 0;
    stats.aura = 0;
    statsDate = getTodayStr();
  }
  updateBars();
}

function saveStats(){
  const today = getTodayStr();
  localStorage.setItem('simStats', JSON.stringify({
    energy: stats.energy,
    mood: stats.mood,
    aura: stats.aura,
    date: today
  }));
}

function updateBars(){
  // N·∫øu gi√° tr·ªã l√† 0 th√¨ bar s·∫Ω kh√¥ng hi·ªán (·∫©n fill)
  const energyBar = document.getElementById('energyBar');
  const moodBar = document.getElementById('moodBar');
  const auraBar = document.getElementById('auraBar');
  energyBar.style.width = stats.energy > 0 ? stats.energy + '%' : '0%';
  moodBar.style.width = stats.mood > 0 ? stats.mood + '%' : '0%';
  auraBar.style.width = stats.aura > 0 ? stats.aura + '%' : '0%';
  energyBar.style.background = stats.energy > 0 ? "#FFD700" : "transparent";
  moodBar.style.background = stats.mood > 0 ? "#4DB6E2" : "transparent";
  auraBar.style.background = stats.aura > 0 ? "#B388EB" : "transparent";
}

// --- Hi·ªáu ·ª©ng story ---
function fadeSnippet(text){
  const snippetDiv = document.getElementById('snippet');
  snippetDiv.style.opacity = 0;
  snippetDiv.style.transform = "translateY(20px) scale(0.95)";
  setTimeout(()=>{
    snippetDiv.textContent = text;
    snippetDiv.style.opacity = 1;
    snippetDiv.style.transform = "translateY(0) scale(1.05)";
    setTimeout(()=>{ snippetDiv.style.transform = "translateY(0) scale(1)"; }, 200);
  }, 80);
}

// --- Modal th√†nh t·ª±u ---
// --- Hi·ªÉn th·ªã modal th√†nh t·ª±u khi ho√†n th√†nh checklist ---
function showMilestone(text) {
  milestoneText.textContent = text;
  modal.classList.remove('hidden');
}
const modal = document.getElementById('milestoneModal');
const milestoneText = document.getElementById('milestoneText');
document.getElementById('closeModal').addEventListener('click',()=>modal.classList.add('hidden'));

// --- Render checklist ---
function renderChecklist(group) {
  const checklistDiv = document.getElementById('checklist-form');
  checklistDiv.innerHTML = '';
  fadeSnippet('');
  if (!group || !checklistData[group]) {
    updateSummary(0, 0, "Ch∆∞a x√°c ƒë·ªãnh", "");
    recalcStatsForCurrentGroup();
    return;
  }
  const items = checklistData[group];
  let currentValues = JSON.parse(localStorage.getItem('progress_' + group) || '[]');
  if (currentValues.length !== items.length) currentValues = items.map(() => false);
  items.forEach((item, idx) => {
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = currentValues[idx];
    if (cb.checked) label.classList.add('checked');
    cb.addEventListener('change', () => {
      currentValues[idx] = cb.checked;
      label.classList.toggle('checked', cb.checked);
      localStorage.setItem('progress_' + group, JSON.stringify(currentValues));
      onChecklistToggle(item, cb.checked, group, idx, label);
      updateChecklistSummary(group, items, currentValues);
      recalcStatsForCurrentGroup(); // lu√¥n t√≠nh l·∫°i t·ªïng bar cho to√†n b·ªô checklist
    });
    label.appendChild(cb);
    label.append(' ' + item);
    checklistDiv.appendChild(label);
  });
  updateChecklistSummary(group, items, currentValues);
  recalcStatsForCurrentGroup(); // lu√¥n t√≠nh l·∫°i t·ªïng bar cho to√†n b·ªô checklist
}

// --- Khi tick checklist ---
function onChecklistToggle(item, checked, group, idx, label) {
  // Kh√¥ng c·ªông tr·ª±c ti·∫øp v√†o stats, ch·ªâ l∆∞u tr·∫°ng th√°i, recalcStatsForCurrentGroup s·∫Ω t√≠nh l·∫°i
  fadeSnippet(storyBank[Math.floor(Math.random() * storyBank.length)]);
  const progress = JSON.parse(localStorage.getItem('progress_' + group) || '[]');
  if (progress.length && progress.every(v => v)) {
    showMilestone(milestoneBank[Math.floor(Math.random() * milestoneBank.length)]);
  }
}

// --- ƒê·ªìng b·ªô checklist summary ---
function updateChecklistSummary(group, items, values) {
  const count = values.filter(Boolean).length;
  const total = items.length;
  const rank = getRank(count, total);
  const motivation = getMotivation(rank);
  updateSummary(count, total, rank, motivation);
  // Kh√¥ng g·ªçi saveHistory n·ªØa v√¨ ƒë√£ x√≥a b·∫£ng th√†nh t·ª±u
}

// --- C·∫≠p nh·∫≠t v√πng summary ---
function updateSummary(count, total, rank, motivation) {
  document.getElementById('count').textContent = count;
  document.getElementById('total').textContent = total;
  // ƒê·ªông l·ª±c n·ªïi b·∫≠t d∆∞·ªõi c√πng
  const motivationSpan = document.getElementById('motivation');
  motivationSpan.textContent = motivation;
  motivationSpan.style.opacity = 0;
  setTimeout(() => {
    motivationSpan.style.opacity = 1;
    motivationSpan.style.transform = "scale(1.08)";
    setTimeout(() => { motivationSpan.style.transform = "scale(1)"; }, 200);
  }, 80);
  // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t ng√†y/x·∫øp lo·∫°i n·ªØa
}

// --- X·∫øp lo·∫°i ---
function getRank(count, total) {
  if (total === 0) return "Ch∆∞a x√°c ƒë·ªãnh";
  const ratio = count / total;
  if (ratio === 1) return "Xu·∫•t s·∫Øc";
  if (ratio >= 0.8) return "T·ªët";
  if (ratio >= 0.5) return "Trung b√¨nh";
  if (ratio > 0) return "C·∫ßn c·ªë g·∫Øng";
  return "Ch∆∞a l√†m";
}

// --- ƒê·ªông l·ª±c ---
function getMotivation(rank) {
  switch(rank) {
    case "Xu·∫•t s·∫Øc": return "Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc checklist h√¥m nay!";
    case "T·ªët": return "R·∫•t t·ªët! H√£y c·ªë g·∫Øng th√™m ƒë·ªÉ ƒë·∫°t m·ª©c xu·∫•t s·∫Øc.";
    case "Trung b√¨nh": return "B·∫°n ƒëang ƒëi ƒë√∫ng h∆∞·ªõng, ti·∫øp t·ª•c ph√°t huy nh√©!";
    case "C·∫ßn c·ªë g·∫Øng": return "ƒê·ª´ng b·ªè cu·ªôc, h√£y th·ª≠ l·∫°i v√†o ng√†y mai!";
    case "Ch∆∞a l√†m": return "B·∫Øt ƒë·∫ßu t·ª´ng b∆∞·ªõc nh·ªè, b·∫°n s·∫Ω l√†m ƒë∆∞·ª£c!";
    default: return "";
  }
}

// --- Kh·ªüi t·∫°o ---
document.addEventListener('DOMContentLoaded', function() {
  if (window.Choices) {
    choicesInstance = new Choices(categorySelect, { removeItemButton: true });
    categorySelect.addEventListener('change', handleCategoryChange);
  } else {
    categorySelect.addEventListener('change', handleCategoryChange);
  }
  // Hi·ªÉn th·ªã l·ªãch b·∫±ng flatpickr, lu√¥n hi·ªán
  if (window.flatpickr) {
    flatpickr("#datePicker", {
      dateFormat: "d/m/Y",
      defaultDate: new Date(),
      allowInput: true,
      clickOpens: true,
      onReady: function(selectedDates, dateStr, instance) {
        // Kh√¥ng t·ª± ƒë·ªông m·ªü l·ªãch, ch·ªâ m·ªü khi click
      },
      onChange: function(selectedDates, dateStr) {
        document.getElementById('date').textContent = dateStr;
        // Reset thanh bar khi ƒë·ªïi ng√†y
        stats.energy = 0; stats.mood = 0; stats.aura = 0;
        saveStats();
        updateBars();
        // Reset t·∫•t c·∫£ checklist ƒë√£ tick cho ng√†y m·ªõi
        Object.keys(checklistData).forEach(group => {
          localStorage.removeItem('progress_' + group);
        });
        if (currentGroup) renderChecklist(currentGroup);
      }
    });
  }
  // ƒê·∫£m b·∫£o lu√¥n c√≥ ng√†y hi·ªÉn th·ªã
  if (!document.getElementById('date').textContent) {
    document.getElementById('date').textContent = getTodayStr();
  }
  loadStats();
  // Kh√¥ng g·ªçi renderHistoryTable n·ªØa
});

// --- C√°c n√∫t ch·ª©c nƒÉng ---
function triggerImport() {
  document.getElementById('import-file').click();
}
function undoChange() {
  if (currentGroup) {
    localStorage.removeItem('progress_' + currentGroup);
    renderChecklist(currentGroup);
  }
}

// --- S·ª± ki·ªán ch·ªçn nh√≥m checklist (KH√îI PH·ª§C logic b·∫£ng so s√°nh khi ch·ªçn nhi·ªÅu nh√≥m) ---
function handleCategoryChange() {
  if (window.Choices && choicesInstance) {
    selectedGroups = choicesInstance.getValue(true);
    if (selectedGroups.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = selectedGroups[0];
      renderChecklist(currentGroup);
    } else if (selectedGroups.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(selectedGroups);
      updateSummary(0, 0, "Ch∆∞a x√°c ƒë·ªãnh", "");
      // Reset thanh bar khi ch·ªçn nhi·ªÅu nh√≥m
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "Ch∆∞a x√°c ƒë·ªãnh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  } else {
    // fallback cho select th∆∞·ªùng
    const values = Array.from(categorySelect.selectedOptions).map(opt => opt.value).filter(Boolean);
    if (values.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = values[0];
      renderChecklist(currentGroup);
    } else if (values.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(values);
      updateSummary(0, 0, "Ch∆∞a x√°c ƒë·ªãnh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "Ch∆∞a x√°c ƒë·ªãnh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  }
}

// --- Bi·ªÉu ƒë·ªì so s√°nh khi ch·ªçn nhi·ªÅu nh√≥m checklist ---
function renderCompareChart(groups) {
  const chartElem = document.getElementById('compareChart');
  chartElem.classList.remove('hidden');
  // Clear canvas before drawing new chart
  chartElem.width = chartElem.width;
  const ctx = chartElem.getContext('2d');
  const labels = groups.map(getGroupName);
  const completed = groups.map(g => {
    const items = checklistData[g] || [];
    const values = JSON.parse(localStorage.getItem('progress_' + g) || '[]');
    return values.filter(Boolean).length;
  });
  const totals = groups.map(g => (checklistData[g] || []).length);

  if (compareChart) compareChart.destroy();
  compareChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Ho√†n th√†nh',
          data: completed,
          backgroundColor: '#4caf50'
        },
        {
          label: 'T·ªïng m·ª•c',
          data: totals,
          backgroundColor: '#c8e6c9'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: { anchor: 'end', align: 'top' }
      },
      scales: {
        y: { beginAtZero: true, precision: 0 }
      }
    }
  });
}

// --- Helper: l·∫•y t√™n nh√≥m checklist ---
function getGroupName(key) {
  const map = {
    chamCoThe: "ChƒÉm C∆° Th·ªÉ",
    chamNhaCua: "ChƒÉm Nh√† C·ª≠a",
    dinhDuong: "Dinh D∆∞·ª°ng",
    langPhi: "Ki·ªÉm So√°t L√£ng Ph√≠",
    aura: "N√¢ng T·∫ßng Aura",
    soThich: "S·ªü Th√≠ch",
    theDuc: "Th·ªÉ D·ª•c"
  };
  return map[key] || key;
}
</script>
</body>
</html>
