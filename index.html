<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Web Đánh Giá Checklist</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { color: #333; }
    label { display: block; margin: 5px 0; }
    .result { margin-top: 20px; font-size: 18px; font-weight: bold; }
    .hidden { display: none; }
    select, button { padding: 5px; font-size: 16px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <h2>Đánh Giá Checklist Cá Nhân</h2>
  
  <label for="category">Chọn nhóm checklist:</label>
  <select id="category">
    <option value="">-- Chọn nhóm --</option>
    <option value="chamCoThe">1. Chăm Cơ Thể</option>
    <option value="chamNhaCua">2. Chăm Nhà Cửa</option>
    <option value="dinhDuong">3. Dinh Dưỡng – Ẩm Thực</option>
    <option value="langPhi">4. Kiểm Soát Lãng Phí</option>
    <option value="aura">5. Nâng Tầng Aura</option>
    <option value="soThich">6. Sở Thích – Dưỡng Khí</option>
    <option value="theDuc">7. Thể Dục – Cơ Xương – Dáng Form</option>
  </select>
  <input type="date" id="selected-date" />
  <button onclick="saveProgress()">Lưu kết quả</button>
  <button onclick="exportData()">Xuất dữ liệu</button>
  <button onclick="triggerImport()">Nhập dữ liệu</button>
  <input type="file" id="import-file" accept=".json" class="hidden" />
  <button onclick="undoChange()">Hoàn tác</button>

  <form id="checklist-form"></form>

  <div class="result">
    Ngày: <span id="date"></span><br>
    Đã hoàn thành: <span id="count">0</span>/<span id="total">0</span><br>
    Hoàn thành: <span id="percent">0%</span><br>
    Xếp loại: <span id="rank">Chưa xác định</span>
  </div>

  <h3>Lịch sử đánh giá</h3>
  <table id="history-table">
    <thead>
      <tr><th>Ngày</th><th>Nhóm</th><th>Hoàn thành</th><th>Xếp loại</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
const checklistData = {
  chamCoThe: [
    "Uống đủ 1.5 – 2L nước (chia 3 khung sáng – chiều – tối)",
    "Rửa mặt sáng + tối",
    "Thoa lotion body (cổ – vai – tay – chân)",
    "Chải tóc – xịt dưỡng ẩm ngọn tóc (nếu tóc khô)",
    "Đánh răng 2 lần/ngày",
    "Tẩy trang / lau sạch mặt nếu dùng kem chống nắng hoặc đi ra ngoài",
    "Làm sạch môi – dưỡng môi",
    "Tắm nước ấm buổi tối (xả stress, reset da)",
    "Dưỡng da body tối (nếu không mệt)",
    "Kéo giãn chân, gập bụng nhẹ 3–5 phút (nếu ngồi lâu)"
  ],
  chamNhaCua: [
    "Xếp chăn gọn sau khi ngủ dậy",
    "Rửa chén bát trong ngày (không để tồn qua đêm)",
    "Quét nhà hoặc lau chùi điểm bẩn rõ rệt",
    "Không để đồ lung tung dưới đất",
    "Dọn đồ trên bàn về đúng góc / vị trí",
    "Đổ rác (tối)"
  ],
  dinhDuong: [
    "1 cốc nước lọc ngay sau khi ngủ dậy",
    "Uống nước 1.5–2L chia sáng/chiều/tối",
    "2–3 bữa chính: đầy đủ carb tốt + đạm + rau",
    "1–2 bữa phụ nhẹ: sữa hạt / trái cây / hạt mix",
    "1 bữa có rau xanh dạng lá (giúp tiêu hóa)",
    "1–2 bữa có trái cây tươi",
    "1 bữa có protein trắng (cá, gà, trứng)",
    "Tránh để quá 6 tiếng không ăn",
    "Không ăn khuya sau 9h tối (trừ khi tập nặng)"
  ],
  langPhi: [
    "Hôm nay có bị rớt mode / tụt khí không? (Nếu có, tự xử chưa?)",
    "Có để bản thân trì hoãn 2 tiếng liên tiếp không lý do?",
    "Mạng xã hội / Tiktok hôm nay có tràn quá 30 phút không?",
    "Có ngồi lướt kiểu vô thức quá 3 lần / ngày không?",
    "Có bị kéo vào nhóm chat / bạn bè không thuộc vòng chiến lược?",
    "Có để bản thân làm việc khi đã mệt / cạn pin không? (Nếu có, có nghỉ hồi pin chưa?)",
    "Có ăn uống đúng khung để giữ nền năng lượng chưa?",
    "Có bị cuốn vào những việc không có giá trị lâu dài? (Ví dụ: drama, thị phi, chuyện vô ích)",
    "Có tiêu hao thời gian vì dọn dẹp / sắp xếp không dứt điểm?"
  ],
  aura: [
    "Thở sâu, vươn người — mở lồng ngực 3–5 phút",
    "Dành 10–15 phút ở một mình — không mạng, không nói",
    "Dưỡng da cổ + vai (song song với dưỡng da mặt)",
    "Ý thức: giữ mặt thả mềm, không cau — môi nhẹ tự nhiên",
    "Nhìn gương 2 phút/ngày: mắt tỉnh — không gồng",
    "Giọng nói: giữ đều, mềm, không cộc",
    "Ăn uống chậm rãi — không nuốt vội",
    "Nghe nhạc tầng cao (nhạc chill – nhạc nền Fantasy – Nature Sound)"
  ],
  soThich: [
    "Xem múa cổ trang hoặc múa võ (10–30’)",
    "Nghe nhạc cụ / sáo / đàn (10–40’)",
    "Thưởng mùi thơm tự nhiên (tinh dầu / hoa / rượu trái cây)",
    "Ngắm 1 hình mỹ nhân khí mềm hoặc khí tỉnh (5–10’)",
    "Vẽ tranh / mặc đẹp / ngồi tĩnh giữa không gian đẹp (15–30’)",
    "Uống nước ép / rượu trái cây (100–200ml)",
    "Luyện giọng ấm (5–10 phút, buổi sáng hoặc tối)",
    "Đọc truyện / bài phân tích sâu (30–60’)",
    "Thu thập 1–3 mẫu / content mới để nạp pattern (15–30’)",
    "Nghe / đọc tài chính – dòng tiền (15–45’)",
    "Làm 1 lần “data hóa” – sơ đồ – hệ hóa 1 chủ đề đang học (tối đa 45’)",
    "Quan sát 1 nhân vật / case người trong ngày → phân tích khí tầng",
    "Vận động nhẹ / bơi / đi bộ / vươn căng 10–20 phút",
    "Ăn 1 bữa ngon có tỉnh khí",
    "Uống đủ nước ấm — không uống lạnh sau 21h",
    "Tránh gió – lạnh – âm khí trực tiếp khi mệt"
  ],
  theDuc: [
    "Kéo giãn nhẹ sau khi ngủ dậy (5 phút)",
    "Đi bộ hoặc di chuyển cơ thể 15–30 phút (tránh ngồi lì)",
    "Vươn vai, xoay cổ, gập người 2 lần/ngày (sáng – tối)",
    "Giữ thẳng cột sống khi ngồi học/làm (ý thức chỉnh)",
    "Xoa bụng theo chiều kim đồng hồ sau ăn (1 phút)",
    "Nhẹ nhàng bóp chân – cổ chân trước khi ngủ"
  ]
};

const form = document.getElementById("checklist-form");
const categorySelect = document.getElementById("category");
const selectedDate = document.getElementById("selected-date");
const dateSpan = document.getElementById("date");
const countSpan = document.getElementById("count");
const totalSpan = document.getElementById("total");
const percentSpan = document.getElementById("percent");
const rankSpan = document.getElementById("rank");
const historyTable = document.getElementById("history-table").querySelector("tbody");

let currentValues = [];
let undoStack = [];

categorySelect.addEventListener("change", loadChecklist);
selectedDate.addEventListener("change", loadChecklist);

function loadLocalHistory() {
  historyTable.innerHTML = "";
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith("checklist_")) {
      const [, date, group] = key.split("_");
      const values = JSON.parse(localStorage.getItem(key));
      addToHistory(date, group, values);
    }
  });
}

async function loadHistoryFromCloud() {
  loadLocalHistory();
  if (!currentUser) return;
  const snap = await db.collection("users").doc(currentUser.uid).collection("checklists").get();
  snap.forEach(doc => {
    const [date, group] = doc.id.split("_");
    addToHistory(date, group, doc.data().values);
  });
}

async function loadChecklist() {
  form.innerHTML = "";
  const group = categorySelect.value;
  const date = selectedDate.value;
  if (!group || !date) return;

  const items = checklistData[group];
  let values = getSavedData(date, group);
  currentValues = values || items.map(() => false);
  undoStack = [];
  items.forEach((item, index) => {
    const label = document.createElement("label");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.name = `check-${index}`;
    checkbox.checked = currentValues[index];
    label.appendChild(checkbox);
    label.append(` ${item}`);
    form.appendChild(label);
  });

  updateStats();
  form.querySelectorAll("input").forEach(input =>
    input.addEventListener("change", handleChange)
  );
}

function updateStats() {
  const date = selectedDate.value;
  const group = categorySelect.value;
  const items = checklistData[group];
  const values = [...form.querySelectorAll("input")].map(i => i.checked);
  currentValues = values;
  const done = values.filter(v => v).length;
  const percent = Math.round((done / items.length) * 100);
  let rank = "Chưa xác định";
  if (percent >= 90) rank = "Xuất sắc";
  else if (percent >= 70) rank = "Tốt";
  else if (percent >= 50) rank = "Trung bình";
  else rank = "Cần cải thiện";

  dateSpan.textContent = date;
  countSpan.textContent = done;
  totalSpan.textContent = items.length;
  percentSpan.textContent = percent + "%";
  rankSpan.textContent = rank;
}

function handleChange() {
  undoStack.push([...currentValues]);
  updateStats();
}

function undoChange() {
  if (undoStack.length === 0) return;
  const prev = undoStack.pop();
  form.querySelectorAll("input").forEach((input, idx) => {
    input.checked = prev[idx];
  });
  updateStats();
}
    
async function saveProgress() {
  const date = selectedDate.value;
  const group = categorySelect.value;
  if (!date || !group) return;

  const values = [...form.querySelectorAll("input")].map(i => i.checked);
  localStorage.setItem(`checklist_${date}_${group}`, JSON.stringify(values));
  if (currentUser) {
    await db.collection("users").doc(currentUser.uid)
      .collection("checklists").doc(`${date}_${group}`)
      .set({ values });
  }
  addToHistory(date, group, values);
  alert("Đã lưu!");
}

function getSavedData(date, group) {
  const data = localStorage.getItem(`checklist_${date}_${group}`);
  return data ? JSON.parse(data) : null;
}

async function getCloudData(date, group) {
  if (!currentUser) return null;
  const docRef = db.collection("users").doc(currentUser.uid)
    .collection("checklists").doc(`${date}_${group}`);
  const snap = await docRef.get();
  return snap.exists ? snap.data().values : null;
}
    
function addToHistory(date, group, values) {
  const existingRow = historyTable.querySelector(`tr[data-id="${date}_${group}"]`);
  const done = values.filter(v => v).length;
  const percent = Math.round((done / values.length) * 100);
  let rank = "Chưa xác định";
  if (percent >= 90) rank = "Xuất sắc";
  else if (percent >= 70) rank = "Tốt";
  else if (percent >= 50) rank = "Trung bình";
  else rank = "Cần cải thiện";

  if (existingRow) {
    existingRow.innerHTML = `<td>${date}</td><td>${group}</td><td>${done}/${values.length}</td><td>${rank}</td>`;
  } else {
    const row = document.createElement("tr");
    row.setAttribute("data-id", `${date}_${group}`);
    row.innerHTML = `<td>${date}</td><td>${group}</td><td>${done}/${values.length}</td><td>${rank}</td>`;
    historyTable.appendChild(row);
  }

  sortHistory();
}

function sortHistory() {
  const rows = Array.from(historyTable.querySelectorAll("tr"));
  rows.sort((a, b) => {
    const dateA = new Date(a.children[0].textContent);
    const dateB = new Date(b.children[0].textContent);
    return dateB - dateA;
  });
  rows.forEach(row => historyTable.appendChild(row));
}
function exportData() {
  if (!confirm("Xuất toàn bộ dữ liệu ra file?")) return;
  const data = {};
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith("checklist_")) {
      data[key] = JSON.parse(localStorage.getItem(key));
    }
  });
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "checklist_data.json";
  a.click();
  URL.revokeObjectURL(url);
}

function triggerImport() {
  document.getElementById("import-file").click();
}

function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    let data;
    try {
      data = JSON.parse(e.target.result);
    } catch {
      alert("File không hợp lệ!");
      return;
    }
    if (!confirm("Nhập dữ liệu sẽ ghi đè dữ liệu hiện có. Tiếp tục?")) return;
    Object.keys(data).forEach(key => {
      if (key.startsWith("checklist_")) {
        localStorage.setItem(key, JSON.stringify(data[key]));
      }
    });
    loadLocalHistory();
    alert("Đã nhập dữ liệu!");
  };
  reader.readAsText(file);
  event.target.value = "";
}

document.getElementById("import-file").addEventListener("change", handleImport);
  </script>
</body>
</html>

