<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Web Đánh Giá Checklist</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f8fa; margin: 0; padding: 30px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    h2 { color: #333; margin-top: 0; }
    h3 { color: #4caf50; margin-top: 30px; }
    label { display: block; margin: 8px 0; }
    select, button, #datePicker { padding: 8px 12px; font-size: 16px; margin-bottom: 10px; }
    #datePicker { border: 1px solid #ccc; border-radius: 8px; font-family: 'Segoe UI', Roboto, sans-serif; background-repeat: no-repeat; background-position: right 10px center; background-size: 16px 16px; padding-right: 32px; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E"); }
    #datePicker:hover, #datePicker:focus { border-color: #4CAFEF; outline: none; }
button { background-color: #4caf50; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #43a047; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #c8e6c9; }
    .result { margin-top: 20px; font-size: 18px; font-weight: bold; }
    .hidden { display: none; }
    label.checked { background-color: #e0ffe0; color: #2e7d32; animation: fade-in 0.3s; }
    .flatpickr-day.complete { background-color: #b2f2bb; color: #000; }
    .flatpickr-day.incomplete { background-color: #ffe6e6; color: #000; }
    #compareChart { max-height: 300px; }
    .progress { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    .progress div { height: 100%; background-color: #4caf50; text-align: center; color: #fff; line-height: 20px; font-weight: bold; }
    .actions { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .date-picker { padding: 8px; border: 1px solid #ccc; border-radius: 8px; transition: border-color 0.2s; }
    .date-picker:hover, .date-picker:focus { border-color: #4CAFEF; outline: none; }
    .action-btn { background-color: #4CAF50; color: #fff; padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; margin-right: 8px; }
    .action-btn:hover { background-color: #43A047; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
    .actions .action-btn:last-child { margin-right: 0; }
    .bars { display: flex; gap: 10px; margin-bottom: 20px; }
    .bar { flex: 1; background: #eee; border-radius: 6px; position: relative; height: 24px; margin: 0 5px; }
    .bar span { position: absolute; left: 8px; top: 0; font-size: 12px; color: #000; line-height: 24px; z-index: 2; }
    .fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
    #energyBar { background: #FFD700; }
    #moodBar { background: #4DB6E2; }
    #auraBar { background: #B388EB; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
#chainHighlightBox {
  border: 2px solid #b2dfdb;
  margin-top: 10px;
  margin-bottom: 12px;
  min-height: 38px;
  padding: 8px 12px;
  transition: background 0.3s, border 0.3s, box-shadow 0.3s;
}
.chain-highlight {
  /* giữ lại class cho hiệu ứng cũ nếu có */
}
#flowScale {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 15px;
  margin-bottom: 10px;
}
/* 🎬 Step 5: Cinematic Flow */

/* Hiệu ứng fade, pulse, float */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes pulseGlow {
  0% { box-shadow: 0 0 0 rgba(76,175,80, 0.4); }
  50% { box-shadow: 0 0 18px rgba(76,175,80, 0.2); }
  100% { box-shadow: 0 0 0 rgba(76,175,80, 0.4); }
}
@keyframes floatBar {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

/* Thanh bar đung đưa */
.bars .fill {
  animation: floatBar 3.5s ease-in-out infinite;
  transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
}

/* Checklist tick cinematic */
label.checked {
  background-color: #e0ffe0;
  color: #2e7d32;
  animation: fadeSlideIn 0.4s ease-out;
  transition: transform 0.2s;
}
label.checked:hover {
  transform: scale(1.02);
}

/* Checklist hover highlight */
#checklist-form label:hover {
  background: #f1fff1;
  transform: translateX(2px);
  transition: transform 0.2s;
}

/* Modal cinematic */
.modal-content {
  animation: fadeSlideIn 0.5s ease-out;
}

/* Chart load fade-in */
#emotionFlowChart {
  opacity: 0;
  transition: opacity 0.8s ease;
}
.chart-loaded {
  opacity: 1 !important;
}

/* Motivation pulse */
#motivationBox span {
  animation: pulseGlow 2.5s ease-in-out infinite;
}
/* --- Fix modal content auto height --- */
#historyModalContent > canvas,
#historyModalContent > table,
#historyModalContent > div,
#historyModalContent > select {
  margin-bottom: 12px;
}

#historyModalContent {
  height: auto !important;
}

#emotionFlowChart {
  min-height: 60px;
  margin-top: 10px;
}
  </style>
</head>
<body>
  <div class="container">
    <h2>Đánh Giá Checklist Cá Nhân</h2>
    <div class="bars">
      <div class="bar"><span>Energy ⚡</span><div class="fill" id="energyBar"></div></div>
      <div class="bar"><span>Mood 😊</span><div class="fill" id="moodBar"></div></div>
      <div class="bar"><span>Aura ✨</span><div class="fill" id="auraBar"></div></div>
    </div>
    <label for="category">Chọn nhóm checklist:</label>
    <select id="category" multiple>
      <option value="">-- Chọn nhóm --</option>
      <option value="chamCoThe">1. 🏋️ Chăm Cơ Thể</option>
      <option value="chamNhaCua">2. 🏠 Chăm Nhà Cửa</option>
      <option value="dinhDuong">3. 🍎 Dinh Dưỡng – Ẩm Thực</option>
      <option value="langPhi">4. 💰 Kiểm Soát Lãng Phí</option>
      <option value="aura">5. ✨ Nâng Tầng Aura</option>
      <option value="soThich">6. 🎭 Sở Thích – Dưỡng Khí</option>
      <option value="theDuc">7. 🏃 Thể Dục – Cơ Xương – Dáng Form</option>
    </select>
    <canvas id="compareChart" class="hidden" style="margin-top:32px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(76,175,80,0.08);"></canvas>
    <div id="progressContainer" class="progress hidden"><div id="progressBar"></div></div>
    <div class="actions">
      <input type="text" id="datePicker" class="date-picker" readonly />
      <button class="action-btn" onclick="triggerImport()">Nhập dữ liệu</button>
      <input type="file" id="import-file" accept=".json" class="hidden" />
      <button class="action-btn" onclick="undoChange()">Hoàn tác</button>
      <button class="action-btn" onclick="exportDataJSON()">💾 Xuất dữ liệu JSON</button>
    </div>
    <h3 id="checklist-title"></h3>
    <div class="result checklist-summary" style="margin-bottom: 10px;">
      <div style="display:none"><span id="date"></span></div>
      <div><strong>Đã hoàn thành:</strong> <span id="count">0</span>/<span id="total">0</span></div>
      <!-- <div><strong>Xếp loại:</strong> <span id="rank" class="grade">Chưa xác định</span></div> -->
    </div>
    <form id="checklist-form"></form>
    <!-- Nút xem lịch sử -->
    <div style="text-align:right; margin: 10px 0 0 0;">
      <button id="viewHistoryBtn" type="button" style="background:#1976d2; color:#fff; border-radius:6px; padding:7px 18px; font-size:16px; font-weight:500; border:none; cursor:pointer;">📆 Xem lịch sử</button>
    </div>
    <!-- Modal popup lịch sử -->
<!-- Modal popup lịch sử -->
<div id="historyModal" class="modal hidden" style="z-index:10000; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); display:none; align-items:center; justify-content:center;">
<div id="historyModalContent" style="background:#fff; border-radius:14px; max-width:900px; width:98vw; display:inline-block; max-height:90vh; overflow:auto; box-shadow:0 4px 32px rgba(25,118,210,0.13); padding:16px 20px; position:relative;">
    <button id="closeHistoryModal" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:26px; color:#888; cursor:pointer;">&times;</button>
    <h2 style="margin-top:0; color:#1976d2;">Lịch sử Checklist</h2>

<!-- Biểu đồ Emotion/Performance Flow -->
<div style="margin-bottom: 10px;">
  <label for="flowScale"><b>Chế độ hiển thị:</b></label>
  <select id="flowScale">
    <option value="daily" selected>Daily</option>
    <option value="weekly">Weekly</option>
    <option value="monthly">Monthly</option>
  </select>
</div>

<!-- Chart Type -->
<div style="margin-bottom: 10px;">
  <label for="chartType"><b>Loại biểu đồ:</b></label>
  <select id="chartType">
    <option value="line" selected>Line</option>
    <option value="radar">Radar</option>
    <option value="bar">Stacked Bar</option>
  </select>
</div>

<!-- Layer Toggle (Energy/Mood/Aura) -->
<div id="layerToggleBox" style="margin:10px 0; display:flex; gap:14px; align-items:center;">
  <label><input type="checkbox" id="toggleEnergy" checked> ⚡ Energy</label>
  <label><input type="checkbox" id="toggleMood" checked> 😊 Mood</label>
  <label><input type="checkbox" id="toggleAura" checked> ✨ Aura</label>
</div>

<canvas id="emotionFlowChart" style="width:100%; max-height:280px; margin-bottom:18px; background:#f8fafd; border-radius:10px;"></canvas>
        <!-- Highlight insight -->
        <div id="historyHighlight" style="margin-bottom:14px; font-size:15px; color:#333;"></div>
        <!-- Bảng lịch sử -->
        <table id="historyTable" style="width:100%; border-collapse:collapse; margin-bottom:18px;">
          <thead>
            <tr style="background:#e3f2fd;">
              <th style="padding:7px 8px;">Ngày</th>
              <th style="padding:7px 8px;">Đã tick</th>
              <th style="padding:7px 8px;">Chi tiết</th>
              <th>❌</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dữ liệu sẽ render động -->
          </tbody>
        </table>
        <!-- Nút export -->
        <div style="display:flex; gap:12px; align-items:center;">
          <button id="exportCSVBtn" type="button" style="background:#388e3c; color:#fff; border-radius:6px; padding:7px 18px; font-size:15px; font-weight:500; border:none; cursor:pointer;">⬇ Xuất CSV</button>
          <button id="exportXLSXBtn" type="button" style="background:#fbc02d; color:#333; border-radius:6px; padding:7px 18px; font-size:15px; font-weight:500; border:none; cursor:pointer;">⬇ Xuất Excel</button>
          <span id="exportMsg" style="margin-left:10px; color:#388e3c; font-size:15px;"></span>
        </div>
      </div>
    </div>
<script>
// --- Lịch sử checklist: mở/đóng modal ---
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('viewHistoryBtn');
  const modal = document.getElementById('historyModal');
  const closeBtn = document.getElementById('closeHistoryModal');

  // 👉 Nhấn nút 📆 -> hiện modal
btn.addEventListener('click', function() {
    modal.style.display = 'flex';

// 🎬 Cinematic: Hiệu ứng khi modal mở
    document.getElementById('historyModalContent').style.animation = "fadeSlideIn 0.5s ease";
    renderHistoryTable();   // ✅ Gọi hàm render bảng khi mở modal
    updateHistoryHighlight();
if (window.emotionChart) window.emotionChart.destroy();
    renderEmotionFlow();  // ✅ 
});

// === XUẤT CSV ===
document.getElementById("exportCSVBtn").addEventListener("click", function () {
  let csv = "Ngày,Đã tick,Chi tiết\n";
  document.querySelectorAll("#historyTable tbody tr").forEach(row => {
    let cols = row.querySelectorAll("td");
    let rowData = Array.from(cols).map(td => `"${td.innerText.replace(/\n/g, " ")}"`).join(",");
    csv += rowData + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-history.csv";
  link.click();
});

// === XUẤT EXCEL (dùng HTML table thành file .xls) ===
document.getElementById("exportXLSXBtn").addEventListener("click", function () {
  let table = document.getElementById("historyTable").outerHTML;
  const blob = new Blob([table], { type: "application/vnd.ms-excel" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-history.xls";
  link.click();
});

  // 👉 Nhấn ❌ -> ẩn modal
  closeBtn.addEventListener('click', function() {
    modal.style.display = 'none';
  });

  // 👉 Click ra ngoài overlay -> ẩn modal
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
});
</script>
    <!-- Chain Highlight Box -->
    <div id="chainHighlightBox" class="chain-highlight" style="min-height:38px; font-size:17px; font-weight:500; text-align:center; border-radius:10px; background:#f8fafd; box-shadow:0 2px 8px rgba(76,175,80,0.06); transition:all 0.3s; display:none;"></div>
    <!-- Đưa snippet lên ngay dưới checklist-form, thêm hiệu ứng đẹp -->
    <div id="snippet" class="snippet" style="margin-top:20px; min-height:32px; font-size:18px; color:#4caf50; font-weight:bold; text-align:center; transition: all 0.3s;"></div>
    <!-- Động lực nổi bật, hiệu ứng thành tựu ĐƯA XUỐNG DƯỚI CÙNG -->
    <div id="motivationBox" style="margin:18px 0 0 0; text-align:center; display:none;">
      <span id="motivation" style="display:inline-block; background:linear-gradient(90deg,#e0ffe0,#b2f2bb,#e0ffe0); color:#1b5e20; font-size:26px; font-weight:bold; border-radius:16px; padding:18px 40px; box-shadow:0 2px 16px rgba(76,175,80,0.12); letter-spacing:1.5px; transition:all 0.3s; border:2px solid #43a047;"></span>
    </div>
    <!-- Đưa story box xuống dưới cùng -->
    <div id="storyBox" style="display:none"><div id="storyMessages"></div></div>
    <!-- Modal thành tựu đẹp hơn -->
    <div id="milestoneModal" class="modal hidden" style="z-index:9999;">
      <div class="modal-content" style="text-align:center; padding:32px 24px; border-radius:16px; background:#fff; box-shadow:0 4px 32px rgba(76,175,80,0.15);">
        <div class="icon" style="font-size:48px; margin-bottom:12px;">🎉</div>
        <p id="milestoneText" style="font-size:22px; color:#388e3c; font-weight:bold; margin-bottom:16px;"></p>
        <button id="closeModal" style="background:#4caf50; color:#fff; border:none; border-radius:8px; padding:8px 24px; font-size:16px; cursor:pointer;">Đóng</button>
        <div id="milestoneStoryMessages"></div>
      </div>
    </div>
   
    <script>

// ✅ Hàm trả về ngày dạng dd/mm/yyyy
// ✅ Hàm chuẩn hóa ngày
function getSelectedDate() {
  const pickerValue = document.getElementById('datePicker')?.value;
  if (pickerValue) return pickerValue;

  const d = new Date();
  return d.getDate().toString().padStart(2, '0') + '/' +
         (d.getMonth() + 1).toString().padStart(2, '0') + '/' +
         d.getFullYear();
}

function getSafeDate() {
  return getSelectedDate().replace(/\//g, "-");
}

// ✅ Hàm đổi / thành - để dùng key localStorage
function getSafeDate() {
  return getSelectedDate().replace(/\//g, "-");
}

// --- Dữ liệu checklist cho từng nhóm ---
const checklistData = {
  chamCoThe: [
    "Uống đủ 1.5–2L nước",
    "Rửa mặt sáng + tối",
    "Thoa lotion body",
    "Chải tóc – xịt dưỡng",
    "Đánh răng 2 lần/ngày",
    "Tẩy trang/lau sạch mặt",
    "Làm sạch môi – dưỡng môi",
    "Tắm nước ấm buổi tối",
    "Dưỡng da body tối",
    "Kéo giãn chân/gập bụng nhẹ"
  ],
  chamNhaCua: [
    "Xếp chăn gọn sau khi ngủ dậy",
    "Rửa chén bát trong ngày",
    "Quét nhà/lau chùi điểm bẩn",
    "Không để đồ lung tung dưới đất",
    "Dọn đồ trên bàn về đúng chỗ",
    "Đổ rác (tối)"
  ],
  dinhDuong: [
    "1 cốc nước ngay sau ngủ dậy",
    "Uống nước 1.5–2L chia sáng/chiều/tối",
    "2–3 bữa chính đủ chất",
    "1–2 bữa phụ nhẹ",
    "1 bữa có rau xanh lá",
    "1–2 bữa có trái cây",
    "1 bữa protein trắng",
    "Không để quá 6 tiếng không ăn",
    "Không ăn khuya sau 9h tối"
  ],
  langPhi: [
    "Không mua đồ không cần thiết",
    "Không tiêu tiền cho thói quen xấu",
    "Kiểm tra ví trước khi ra ngoài",
    "Ghi chú chi tiêu trong ngày"
  ],
  aura: [
    "Thiền hoặc thở sâu 5 phút",
    "Đọc sách phát triển bản thân",
    "Viết nhật ký cảm xúc",
    "Nghe nhạc thư giãn"
  ],
  soThich: [
    "Vẽ/trang trí/viết lách",
    "Chơi nhạc cụ hoặc nghe nhạc",
    "Tập thể thao nhẹ nhàng",
    "Chăm sóc cây cảnh/thú cưng"
  ],
  theDuc: [
    "Khởi động 5 phút",
    "Tập thể dục ít nhất 15 phút",
    "Đi bộ 5000 bước trở lên",
    "Giãn cơ sau tập"
  ]
};

// --- Chain relations: mapping checklist items to their cause-effect chains ---
const chainRelations = {
  // Chăm Cơ Thể
  "Uống đủ 1.5–2L nước": [
    { text: "Cơ thể được bù nước", positive: true },
    { text: "Tuần hoàn tốt hơn", positive: true },
    { text: "Da căng & sạch", positive: true },
    { text: "Năng lượng + tập trung", positive: true }
  ],
  "Rửa mặt sáng + tối": [
    { text: "Da sạch bụi/dầu", positive: true },
    { text: "Giảm mụn & dị ứng", positive: true },
    { text: "Tự tin khi giao tiếp", positive: true }
  ],
  "Thoa lotion body": [
    { text: "Da ẩm & mềm", positive: true },
    { text: "Tránh khô nứt", positive: true },
    { text: "Cảm giác dễ chịu", positive: true },
    { text: "Aura dịu", positive: true }
  ],
  "Chải tóc – xịt dưỡng": [
    { text: "Tóc gọn & bóng", positive: true },
    { text: "Ngoại hình chỉnh chu", positive: true },
    { text: "Tự tin hơn", positive: true }
  ],
  "Đánh răng 2 lần/ngày": [
    { text: "Hơi thở thơm & sạch", positive: true },
    { text: "Tự tin trò chuyện", positive: true },
    { text: "Aura tốt", positive: true }
  ],
  "Tẩy trang/lau sạch mặt": [
    { text: "Lỗ chân lông sạch", positive: true },
    { text: "Giảm mụn", positive: true },
    { text: "Cảm giác nhẹ mặt", positive: true }
  ],
  "Làm sạch môi – dưỡng môi": [
    { text: "Môi mềm & hồng", positive: true },
    { text: "Gương mặt tươi", positive: true },
    { text: "Tự tin", positive: true }
  ],
  "Tắm nước ấm buổi tối": [
    { text: "Giảm căng cơ & stress", positive: true },
    { text: "Ngủ sâu hơn", positive: true },
    { text: "Sáng dậy tỉnh táo", positive: true }
  ],
  "Dưỡng da body tối": [
    { text: "Da mềm, mịn", positive: true },
    { text: "Cảm giác 'chăm sóc bản thân'", positive: true },
    { text: "Tự tin & dễ chịu", positive: true }
  ],
  "Kéo giãn chân/gập bụng nhẹ": [
    { text: "Giảm đau cơ sau ngồi lâu", positive: true },
    { text: "Lưu thông máu", positive: true },
    { text: "Dáng form ổn", positive: true }
  ],
  // Chăm Nhà Cửa
  "Xếp chăn gọn sau khi ngủ dậy": [
    { text: "Giường gọn gàng", positive: true },
    { text: "Không gian sạch", positive: true },
    { text: "Não ít rối", positive: true },
    { text: "Mood tốt", positive: true }
  ],
  "Rửa chén bát trong ngày": [
    { text: "Nhà bếp sạch", positive: true },
    { text: "Không mùi hôi", positive: true },
    { text: "Tâm lý thoải mái", positive: true },
    { text: "Dễ nấu ăn", positive: true }
  ],
  "Quét nhà/lau chùi điểm bẩn": [
    { text: "Không gian sạch sẽ", positive: true },
    { text: "Aura nhà 'thở'", positive: true },
    { text: "Tâm trạng nhẹ", positive: true }
  ],
  "Không để đồ lung tung dưới đất": [
    { text: "Phòng gọn", positive: true },
    { text: "Giảm vướng víu", positive: true },
    { text: "Cảm giác kiểm soát", positive: true }
  ],
  "Dọn đồ trên bàn về đúng chỗ": [
    { text: "Bàn sạch", positive: true },
    { text: "Não bớt loạn", positive: true },
    { text: "Hiệu suất học/làm việc cao hơn", positive: true }
  ],
  "Đổ rác (tối)": [
    { text: "Không mùi hôi, không kiến gián", positive: true },
    { text: "Không gian 'sạch khí'", positive: true }
  ],
  // Dinh Dưỡng – Ẩm Thực
  "1 cốc nước ngay sau ngủ dậy": [
    { text: "Thải độc đêm", positive: true },
    { text: "Hệ tiêu hóa kích hoạt", positive: true },
    { text: "Não tỉnh", positive: true }
  ],
  "Uống nước 1.5–2L chia sáng/chiều/tối": [
    { text: "Da ẩm & sạch", positive: true },
    { text: "Thận khỏe", positive: true },
    { text: "Năng lượng đều", positive: true }
  ],
  "2–3 bữa chính đủ chất": [
    { text: "Đường huyết ổn", positive: true },
    { text: "Năng lượng bền", positive: true },
    { text: "Không uể oải", positive: true }
  ],
  "1–2 bữa phụ nhẹ": [
    { text: "Không đói gắt", positive: true },
    { text: "Kiểm soát ăn vặt", positive: true },
    { text: "Cân nặng ổn định", positive: true }
  ],
  "1 bữa có rau xanh lá": [
    { text: "Chất xơ", positive: true },
    { text: "Hệ tiêu hóa khỏe", positive: true },
    { text: "Da đẹp", positive: true }
  ],
  "1–2 bữa có trái cây": [
    { text: "Vitamin", positive: true },
    { text: "Miễn dịch tốt", positive: true },
    { text: "Cảm giác tươi mới", positive: true }
  ],
  "1 bữa protein trắng": [
    { text: "Cơ bắp phục hồi", positive: true },
    { text: "Giảm mệt", positive: true },
    { text: "Ngủ tốt hơn", positive: true }
  ],
  "Không để quá 6 tiếng không ăn": [
    { text: "Đường huyết không rớt", positive: true },
    { text: "Không chóng mặt", positive: true },
    { text: "Năng suất ổn", positive: true }
  ],
  "Không ăn khuya sau 9h tối": [
    { text: "Dạ dày nghỉ", positive: true },
    { text: "Ngủ ngon hơn", positive: true },
    { text: "Sáng tỉnh", positive: true }
  ],
  // Kiểm Soát Lãng Phí
  "Không mua đồ không cần thiết": [
    { text: "Giữ tiền", positive: true },
    { text: "Giảm áp lực tài chính", positive: true },
    { text: "Đầu óc nhẹ", positive: true }
  ],
  "Không tiêu tiền cho thói quen xấu": [
    { text: "Ít cảm giác tội lỗi", positive: true },
    { text: "Tinh thần ổn định", positive: true }
  ],
  "Kiểm tra ví trước khi ra ngoài": [
    { text: "Kiểm soát chi tiêu", positive: true },
    { text: "Hạn chế mua impulsive", positive: true }
  ],
  "Ghi chú chi tiêu trong ngày": [
    { text: "Nhìn rõ dòng tiền", positive: true },
    { text: "Quản lý tốt", positive: true },
    { text: "Ít stress tài chính", positive: true }
  ],
  // Nâng Tầng Aura
  "Thiền hoặc thở sâu 5 phút": [
    { text: "Giảm stress", positive: true },
    { text: "Não tĩnh", positive: true },
    { text: "Aura sáng", positive: true }
  ],
  "Đọc sách phát triển bản thân": [
    { text: "Tư duy mở", positive: true },
    { text: "Tự tin", positive: true },
    { text: "Aura mạnh", positive: true }
  ],
  "Viết nhật ký cảm xúc": [
    { text: "Xả cảm xúc", positive: true },
    { text: "Cân bằng", positive: true },
    { text: "Aura tĩnh", positive: true }
  ],
  "Nghe nhạc thư giãn": [
    { text: "Não reset", positive: true },
    { text: "Thoải mái", positive: true },
    { text: "Aura dịu", positive: true }
  ],
  // Sở Thích – Dưỡng Khí
  "Vẽ/trang trí/viết lách": [
    { text: "Kích thích sáng tạo", positive: true },
    { text: "Tâm an", positive: true },
    { text: "Aura nghệ", positive: true }
  ],
  "Chơi nhạc cụ hoặc nghe nhạc": [
    { text: "Endorphin", positive: true },
    { text: "Vui vẻ", positive: true },
    { text: "Aura sáng", positive: true }
  ],
  "Tập thể thao nhẹ nhàng": [
    { text: "Cơ thể linh hoạt", positive: true },
    { text: "Mood tốt", positive: true },
    { text: "Aura khỏe", positive: true }
  ],
  "Chăm sóc cây cảnh/thú cưng": [
    { text: "Nuôi dưỡng cảm xúc", positive: true },
    { text: "Aura ấm", positive: true }
  ],
  // Thể Dục – Cơ Xương – Dáng Form
  "Khởi động 5 phút": [
    { text: "Giảm nguy cơ chấn thương", positive: true },
    { text: "Tập hiệu quả", positive: true }
  ],
  "Tập thể dục ít nhất 15 phút": [
    { text: "Endorphin", positive: true },
    { text: "Năng lượng tăng", positive: true },
    { text: "Ngủ sâu", positive: true }
  ],
  "Đi bộ 5000 bước trở lên": [
    { text: "Tim mạch & phổi khỏe", positive: true },
    { text: "Lưu thông máu", positive: true },
    { text: "Mood tốt", positive: true }
  ],
  "Giãn cơ sau tập": [
    { text: "Cơ phục hồi", positive: true },
    { text: "Giảm đau", positive: true },
    { text: "Tập đều hơn", positive: true }
  ]
};



// --- Cập nhật chain highlight box ---
function updateChainHighlight(item, checked, anyChecked) {
  const box = document.getElementById('chainHighlightBox');
  if (!box) return;
  if (!anyChecked) {
    box.style.display = 'none';
    box.textContent = '';
    return;
  }
  let chain = chainRelations[item];
  if (!chain) {
    box.textContent = '';
    box.style.background = '#f8fafd';
    box.style.display = '';
    return;
  }
  // Nếu bỏ tick, hiển thị chuỗi tiêu cực (đảo ngược, màu đỏ)
  if (!checked) {
    box.innerHTML = chain.map(e => `<span style='color:#e53935;'>${e.text}</span>`).reverse().join(' <span style="color:#e53935;font-weight:bold;">→</span> ');
    box.style.background = '#fff3f3';
  } else {
    box.innerHTML = chain.map(e => `<span style='color:#388e3c;'>${e.text}</span>`).join(' <span style="color:#388e3c;font-weight:bold;">→</span> ');
    box.style.background = '#e8f5e9';
  }
  box.style.display = '';
}

// Hàm an toàn cho localStorage (đổi / thành -)
function getSafeDate() {
  return getSelectedDate().replace(/\//g,"-");
}
const checklistValues = {
  // Chăm Cơ Thể
  "Uống đủ 1.5–2L nước": { energy: 2, mood: 1, aura: 1 },
  "Rửa mặt sáng + tối": { energy: 1, mood: 1, aura: 1 },
  "Thoa lotion body": { energy: 1, mood: 1, aura: 1 },
  "Chải tóc – xịt dưỡng": { energy: 1, mood: 1, aura: 1 },
  "Đánh răng 2 lần/ngày": { energy: 1, mood: 1, aura: 1 },
  "Tẩy trang/lau sạch mặt": { energy: 1, mood: 1, aura: 1 },
  "Làm sạch môi – dưỡng môi": { energy: 1, mood: 1, aura: 1 },
  "Tắm nước ấm buổi tối": { energy: 1, mood: 1, aura: 1 },
  "Dưỡng da body tối": { energy: 1, mood: 1, aura: 1 },
  "Kéo giãn chân/gập bụng nhẹ": { energy: 1, mood: 1, aura: 1 },
  // Chăm Nhà Cửa
  "Xếp chăn gọn sau khi ngủ dậy": { energy: 1, mood: 1, aura: 1 },
  "Rửa chén bát trong ngày": { energy: 1, mood: 1, aura: 1 },
  "Quét nhà/lau chùi điểm bẩn": { energy: 1, mood: 1, aura: 1 },
  "Không để đồ lung tung dưới đất": { energy: 1, mood: 1, aura: 1 },
  "Dọn đồ trên bàn về đúng chỗ": { energy: 1, mood: 1, aura: 1 },
  "Đổ rác (tối)": { energy: 1, mood: 1, aura: 1 },
  // Dinh Dưỡng – Ẩm Thực
  "1 cốc nước ngay sau ngủ dậy": { energy: 2, mood: 1, aura: 1 },
  "Uống nước 1.5–2L chia sáng/chiều/tối": { energy: 2, mood: 1, aura: 1 },
  "2–3 bữa chính đủ chất": { energy: 2, mood: 2, aura: 1 },
  "1–2 bữa phụ nhẹ": { energy: 2, mood: 2, aura: 1 },
  "1 bữa có rau xanh lá": { energy: 2, mood: 1, aura: 1 },
  "1–2 bữa có trái cây": { energy: 2, mood: 2, aura: 1 },
  "1 bữa protein trắng": { energy: 3, mood: 1, aura: 1 },
  "Không để quá 6 tiếng không ăn": { energy: 1, mood: 1, aura: 1 },
  "Không ăn khuya sau 9h tối": { energy: 2, mood: 1, aura: 1 },
  // Kiểm soát lãng phí
  "Không mua đồ không cần thiết": { energy: 0, mood: 0, aura: 5 },
  "Không tiêu tiền cho thói quen xấu": { energy: 0, mood: 0, aura: 5 },
  "Kiểm tra ví trước khi ra ngoài": { energy: 0, mood: 0, aura: 2 },
  "Ghi chú chi tiêu trong ngày": { energy: 0, mood: 0, aura: 3 },
  // Aura
  "Thiền hoặc thở sâu 5 phút": { energy: 0, mood: 5, aura: 5 },
  "Đọc sách phát triển bản thân": { energy: 0, mood: 3, aura: 5 },
  "Viết nhật ký cảm xúc": { energy: 0, mood: 4, aura: 4 },
  "Nghe nhạc thư giãn": { energy: 0, mood: 5, aura: 3 },
  // Sở thích
  "Vẽ/trang trí/viết lách": { energy: 0, mood: 4, aura: 4 },
  "Chơi nhạc cụ hoặc nghe nhạc": { energy: 0, mood: 5, aura: 3 },
  "Tập thể thao nhẹ nhàng": { energy: 0, mood: 3, aura: 2 },
  "Chăm sóc cây cảnh/thú cưng": { energy: 0, mood: 4, aura: 3 },
  // Thể dục
  "Khởi động 5 phút": { energy: 5, mood: 0, aura: 0 },
  "Tập thể dục ít nhất 15 phút": { energy: 10, mood: 0, aura: 0 },
  "Đi bộ 5000 bước trở lên": { energy: 8, mood: 0, aura: 0 },
  "Giãn cơ sau tập": { energy: 2, mood: 0, aura: 0 }
};


const storyBank = [
  "Một làn khí nhẹ lan ra quanh bạn.",
  "Bạn thấy cơ thể mình ấm lên một chút.",
  "Bạn cảm thấy tinh thần phấn chấn hơn.",
  "Bạn vừa hoàn thành một bước nhỏ cho bản thân.",
  "Bạn đã chăm sóc tốt cho chính mình hôm nay."
];
const milestoneBank = [
  "Cơ thể này như vừa được reset.",
  "Căn phòng này giờ thở cùng bạn.",
  "Bạn đã đạt một cột mốc mới!",
  "Bạn xứng đáng với thành tựu này!"
];

// --- Biến toàn cục ---
let selectedGroups = [];
let currentGroup = "";
let choicesInstance;
let compareChart;
const categorySelect = document.getElementById('category');

// --- Thanh trạng thái ---
// --- Tính lại tổng điểm energy, mood, aura cho nhóm hiện tại ---
function recalcStatsForCurrentGroup() {
  stats.energy = 0;
  stats.mood = 0;
  stats.aura = 0;
  if (!currentGroup || !checklistData[currentGroup]) {
    updateBars();
    saveStats();
    return;
  }
  const items = checklistData[currentGroup];
  const values = JSON.parse(localStorage.getItem(`progress_${currentGroup}_${getSafeDate()}`) || '[]');
  for (let i = 0; i < items.length; i++) {
    if (values[i]) {
      const val = checklistValues[items[i]] || { energy: 0, mood: 0, aura: 0 };
      stats.energy += val.energy;
      stats.mood += val.mood;
      stats.aura += val.aura;
    }
  }
  updateBars();
  saveStats();
}
const stats = { energy: 0, mood: 0, aura: 0 };
let statsDate = ""; // ngày hiện tại của thanh bar

function loadStats() {
  // Lấy trạng thái thanh bar từ localStorage
  const saved = JSON.parse(localStorage.getItem('simStats') || '{}');
  if (saved && saved.date === getSafeDate()) {
    stats.energy = saved.energy || 0;
    stats.mood = saved.mood || 0;
    stats.aura = saved.aura || 0;
    statsDate = saved.date;
  } else {
    stats.energy = 0;
    stats.mood = 0;
    stats.aura = 0;
    statsDate = getSafeDate();
  }
  updateBars();
}

function saveStats(){
  const today = getSafeDate();
  localStorage.setItem('simStats', JSON.stringify({
    energy: stats.energy,
    mood: stats.mood,
    aura: stats.aura,
    date: today
  }));
}

function updateBars(){
  // Tính tổng tối đa cho từng loại (energy, mood, aura) dựa trên checklist hiện tại
  let maxEnergy = 0, maxMood = 0, maxAura = 0;
  if (currentGroup && checklistData[currentGroup]) {
    const items = checklistData[currentGroup];
    for (let i = 0; i < items.length; i++) {
      const val = checklistValues[items[i]] || { energy: 0, mood: 0, aura: 0 };
      maxEnergy += val.energy;
      maxMood += val.mood;
      maxAura += val.aura;
    }
  } else {
    // Nếu không có nhóm nào, mặc định max là 100 để bar không bị NaN
    maxEnergy = maxMood = maxAura = 100;
  }
  // Nếu max = 0 thì bar sẽ không hiện (ẩn fill)
  const energyBar = document.getElementById('energyBar');
  const moodBar = document.getElementById('moodBar');
  const auraBar = document.getElementById('auraBar');
  const energyPercent = (maxEnergy > 0) ? Math.round((stats.energy / maxEnergy) * 100) : 0;
  const moodPercent = (maxMood > 0) ? Math.round((stats.mood / maxMood) * 100) : 0;
  const auraPercent = (maxAura > 0) ? Math.round((stats.aura / maxAura) * 100) : 0;
  energyBar.style.width = energyPercent > 0 ? energyPercent + '%' : '0%';
  moodBar.style.width = moodPercent > 0 ? moodPercent + '%' : '0%';
  auraBar.style.width = auraPercent > 0 ? auraPercent + '%' : '0%';
  energyBar.style.background = energyPercent > 0 ? "#FFD700" : "transparent";
  moodBar.style.background = moodPercent > 0 ? "#4DB6E2" : "transparent";
  auraBar.style.background = auraPercent > 0 ? "#B388EB" : "transparent";
}

// --- Hiệu ứng story ---
function fadeSnippet(text){
  const snippetDiv = document.getElementById('snippet');
  snippetDiv.style.opacity = 0;
  snippetDiv.style.transform = "translateY(20px) scale(0.95)";
  setTimeout(()=>{
    snippetDiv.textContent = text;
    snippetDiv.style.opacity = 1;
    snippetDiv.style.transform = "translateY(0) scale(1.05)";
    setTimeout(()=>{ snippetDiv.style.transform = "translateY(0) scale(1)"; }, 200);
  }, 80);
}

// --- Modal thành tựu ---
// --- Hiển thị modal thành tựu khi hoàn thành checklist ---
function showMilestone(text) {
  milestoneText.textContent = text;
  modal.classList.remove('hidden');
}
const modal = document.getElementById('milestoneModal');
const milestoneText = document.getElementById('milestoneText');
document.getElementById('closeModal').addEventListener('click',()=>modal.classList.add('hidden'));

// --- Render checklist ---
function renderChecklist(group) {
  const checklistDiv = document.getElementById('checklist-form');
  checklistDiv.innerHTML = '';


// 🎬 Cinematic: checklist fade-in
checklistDiv.style.opacity = 0;
setTimeout(() => {
  checklistDiv.style.transition = "opacity 0.5s ease";
  checklistDiv.style.opacity = 1;
}, 50);

  fadeSnippet('');
  const chainBox = document.getElementById('chainHighlightBox');
  const motivationBox = document.getElementById('motivationBox');
  if (!group || !checklistData[group]) {
    chainBox.style.display = 'none';
    motivationBox.style.display = 'none';
    updateSummary(0, 0, "Chưa xác định", "", false);
    recalcStatsForCurrentGroup();
    return;
  }
  const items = checklistData[group];
  let currentValues = JSON.parse(localStorage.getItem(`progress_${group}_${getSafeDate()}`) || '[]');
  if (currentValues.length !== items.length) currentValues = items.map(() => false);
  // Kiểm tra có mục nào đã tick chưa
  let anyChecked = currentValues.some(Boolean);
  if (!anyChecked) {
    chainBox.style.display = 'none';
    motivationBox.style.display = 'none';
  }
  items.forEach((item, idx) => {
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = currentValues[idx];
    if (cb.checked) label.classList.add('checked');
    cb.addEventListener('change', () => {
      currentValues[idx] = cb.checked;
      label.classList.toggle('checked', cb.checked);

    // 🎯 GỌI TALOS NGAY KHI TICK/BỎ TICK
    talosReply("Checklist mục: " + item + " vừa " + (cb.checked ? "được tick ✅" : "bỏ tick ❌"))
      .then(reply => {
        document.getElementById("talos-messages").innerHTML += 
          "<div style='margin:5px 0; padding:5px; background:#f7f7f7; border-radius:4px;'>" + reply + "</div>";
      });

// 🎬 Cinematic: rung nhẹ khi tick
  if (cb.checked) {
    label.style.transform = "scale(1.05)";
    setTimeout(() => label.style.transform = "scale(1)", 150);
  }

      const safeDate = getSelectedDate().replace(/\//g,"-");
localStorage.setItem(`progress_${group}_${getSafeDate()}`, JSON.stringify(currentValues));
      // Kiểm tra lại số lượng tick sau khi thay đổi
      let anyCheckedNow = currentValues.some(Boolean);
      updateChainHighlight(item, cb.checked, anyCheckedNow);
      updateChecklistSummary(group, items, currentValues, anyCheckedNow);
      recalcStatsForCurrentGroup(); // luôn tính lại tổng bar cho toàn bộ checklist
      syncCompareChart(); // ✅ lắng nghe tick checklist ngay khi render xong
    });
    label.appendChild(cb);
    label.append(' ' + item);
    checklistDiv.appendChild(label);
  });
  updateChecklistSummary(group, items, currentValues, anyChecked);
  recalcStatsForCurrentGroup(); // luôn tính lại tổng bar cho toàn bộ checklist
}

// --- Khi tick checklist ---
function onChecklistToggle(item, checked, group, idx, label) {
  // Không cộng trực tiếp vào stats, chỉ lưu trạng thái, recalcStatsForCurrentGroup sẽ tính lại
  fadeSnippet(storyBank[Math.floor(Math.random() * storyBank.length)]);
  updateChainHighlight(item, checked);
  const progress = JSON.parse(localStorage.getItem('progress_' + group + '_' + getSelectedDate().replace(/\//g,"-") ) || '[]');
  if (progress.length && progress.every(v => v)) {
    showMilestone(milestoneBank[Math.floor(Math.random() * milestoneBank.length)]);
  }
    // 🎬 Cinematic: highlight bar khi hoàn thành hết checklist
    document.querySelectorAll('.fill').forEach(bar => {
      bar.style.boxShadow = "0 0 20px rgba(255,255,255,0.8)";
      setTimeout(()=> bar.style.boxShadow = "none", 600);
    });
syncCompareChart();  // ✅ mỗi lần render checklist thì đồng bộ chart
}

// --- Đồng bộ checklist summary ---
function updateChecklistSummary(group, items, values, anyChecked) {
  const count = values.filter(Boolean).length;
  const total = items.length;
  const rank = getRank(count, total);
  const motivation = getMotivation(rank);
  updateSummary(count, total, rank, motivation, anyChecked);
  // Không gọi saveHistory nữa vì đã xóa bảng thành tựu
}

// --- Cập nhật vùng summary ---
function updateSummary(count, total, rank, motivation, anyChecked) {
  document.getElementById('count').textContent = count;
  document.getElementById('total').textContent = total;
  // Động lực nổi bật dưới cùng
  const motivationBox = document.getElementById('motivationBox');
  const motivationSpan = document.getElementById('motivation');
  if (anyChecked) {
    motivationBox.style.display = '';
    motivationSpan.textContent = motivation;
    motivationSpan.style.opacity = 0;
    setTimeout(() => {
      motivationSpan.style.opacity = 1;
      motivationSpan.style.transform = "scale(1.08)";
      setTimeout(() => { motivationSpan.style.transform = "scale(1)"; }, 200);
    }, 80);
  } else {
    motivationBox.style.display = 'none';
    motivationSpan.textContent = '';
  }
  // Không cần cập nhật ngày/xếp loại nữa
}

// --- Xếp loại ---
function getRank(count, total) {
  if (total === 0) return "Chưa xác định";
  const ratio = count / total;
  if (ratio === 1) return "Xuất sắc";
  if (ratio >= 0.8) return "Tốt";
  if (ratio >= 0.5) return "Trung bình";
  if (ratio > 0) return "Cần cố gắng";
  return "Chưa làm";
}

// --- Động lực ---
function getMotivation(rank) {
  switch(rank) {
    case "Xuất sắc": return "Tuyệt vời! Bạn đã hoàn thành xuất sắc checklist hôm nay!";
    case "Tốt": return "Rất tốt! Hãy cố gắng thêm để đạt mức xuất sắc.";
    case "Trung bình": return "Bạn đang đi đúng hướng, tiếp tục phát huy nhé!";
    case "Cần cố gắng": return "Đừng bỏ cuộc, hãy thử lại vào ngày mai!";
    case "Chưa làm": return "Bắt đầu từng bước nhỏ, bạn sẽ làm được!";
    default: return "";
  }
}

// --- Khởi tạo ---
document.addEventListener('DOMContentLoaded', function() {
  if (window.Choices) {
    choicesInstance = new Choices(categorySelect, { removeItemButton: true });
    categorySelect.addEventListener('change', handleCategoryChange);
  } else {
    categorySelect.addEventListener('change', handleCategoryChange);
  }
  // Hiển thị lịch bằng flatpickr, luôn hiện
  if (window.flatpickr) {
    flatpickr("#datePicker", {
      dateFormat: "d/m/Y",
      defaultDate: new Date(),
      allowInput: true,
      clickOpens: true,
      onReady: function(selectedDates, dateStr, instance) {
        // Không tự động mở lịch, chỉ mở khi click
      },
      onChange: function(selectedDates, dateStr) {
        document.getElementById('date').textContent = dateStr;
        // Reset thanh bar khi đổi ngày
        stats.energy = 0; stats.mood = 0; stats.aura = 0;
        saveStats();
        updateBars();
        // Reset tất cả checklist đã tick cho ngày mới
        Object.keys(checklistData).forEach(group => {
          localStorage.removeItem('progress_' + group);
        });
        if (currentGroup) renderChecklist(currentGroup);
      }
    });
  }
  // Đảm bảo luôn có ngày hiển thị
  if (!document.getElementById('date').textContent) {
    document.getElementById('date').textContent = getSelectedDate().replace(/\//g,"-") ;
  }
  loadStats();
  // Không gọi renderHistoryTable nữa
});

// --- Các nút chức năng ---
function triggerImport() {
  document.getElementById('import-file').click();
}
function undoChange() {
  if (currentGroup) {
    localStorage.removeItem('progress_' + currentGroup + '_' + getSafeDate());
    renderChecklist(currentGroup);
  }
}

// --- Sự kiện chọn nhóm checklist (KHÔI PHỤC logic bảng so sánh khi chọn nhiều nhóm) ---
function handleCategoryChange() {
  if (window.Choices && choicesInstance) {
    selectedGroups = choicesInstance.getValue(true);
    if (selectedGroups.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = selectedGroups[0];
      renderChecklist(currentGroup);
    } else if (selectedGroups.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(selectedGroups);
      updateSummary(0, 0, "Chưa xác định", "");
      // Reset thanh bar khi chọn nhiều nhóm
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "Chưa xác định", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  } else {
    // fallback cho select thường
    const values = Array.from(categorySelect.selectedOptions).map(opt => opt.value).filter(Boolean);
    if (values.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = values[0];
      renderChecklist(currentGroup);
    } else if (values.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(values);
      updateSummary(0, 0, "Chưa xác định", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "Chưa xác định", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  }
}

// --- Biểu đồ so sánh khi chọn nhiều nhóm checklist ---
function renderCompareChart(groups) {
  const chartElem = document.getElementById('compareChart');
  chartElem.classList.remove('hidden');
  // Clear canvas before drawing new chart
  chartElem.width = chartElem.width;
  const ctx = chartElem.getContext('2d');
  const labels = groups.map(getGroupName);
  const completed = groups.map(g => {
    const items = checklistData[g] || [];
    const values = JSON.parse(localStorage.getItem('progress_' + g + '_' + getSelectedDate().replace(/\//g,"-") ) || '[]');
    return values.filter(Boolean).length;
  });
  const totals = groups.map(g => (checklistData[g] || []).length);

  if (compareChart) compareChart.destroy();
  compareChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Hoàn thành',
          data: completed,
          backgroundColor: '#4caf50'
        },
        {
          label: 'Tổng mục',
          data: totals,
          backgroundColor: '#c8e6c9'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: { anchor: 'end', align: 'top' }
      },
      scales: {
        y: { beginAtZero: true, precision: 0 }
      }
    }
  });
}

// --- Helper: lấy tên nhóm checklist ---
function getGroupName(key) {
  const map = {
    chamCoThe: "Chăm Cơ Thể",
    chamNhaCua: "Chăm Nhà Cửa",
    dinhDuong: "Dinh Dưỡng",
    langPhi: "Kiểm Soát Lãng Phí",
    aura: "Nâng Tầng Aura",
    soThich: "Sở Thích",
    theDuc: "Thể Dục"
  };
  return map[key] || key;
}

// === HÀM MỚI: render dữ liệu vào bảng lịch sử ===
function renderHistoryTable() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  const allKeys = Object.keys(localStorage).filter(k => k.startsWith("progress_"));

  if (allKeys.length === 0) {
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#888;'>Chưa có dữ liệu</td></tr>";
    return;
    document.getElementById("historyModalContent").style.paddingBottom = "16px";
  }

  allKeys.forEach(key => {
    const parts = key.replace("progress_", "").split("_");
    const group = parts[0];
    const date = parts.slice(1).join("_");

    const ticks = JSON.parse(localStorage.getItem(key) || "[]");
    const items = checklistData[group] || [];
    const completed = ticks.filter(Boolean).length;
    const total = items.length;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td>${completed}/${total}</td>
      <td>${items.map((item, idx) => ticks[idx] ? "✅ " + item : "❌ " + item).join("<br>")}</td>
      <td>
        <button class="delete-row" data-key="${key}"
    style="background:#e53935; color:#fff; border:none; border-radius:6px;
    padding:4px 10px; cursor:pointer; font-weight:bold;">
    🗑
  </button>
</td>
    `;
    tbody.appendChild(tr);
  });

  // 👉 Gắn sự kiện xóa cho tất cả nút delete-row
  document.querySelectorAll(".delete-row").forEach(btn => {
    btn.addEventListener("click", function() {
      const key = this.getAttribute("data-key");
      if (confirm("Bạn có chắc muốn xóa dữ liệu ngày này không?")) {
        localStorage.removeItem(key);
        renderHistoryTable();    // refresh bảng
        renderEmotionFlow();     // refresh biểu đồ sau xóa
      }
    });
  });
}

// === TẠO INSIGHT CHO BOX #historyHighlight ===
function updateHistoryHighlight() {
  const highlightBox = document.getElementById("historyHighlight");
  const rows = document.querySelectorAll("#historyTable tbody tr");
  
  if (!rows.length || rows[0].innerText.includes("Chưa có dữ liệu")) {
    highlightBox.innerHTML = "❌ Chưa có dữ liệu để thống kê.";
    return;
  }

  let total = 0, done = 0, bestDay = "", bestScore = 0;

  rows.forEach(row => {
    const date = row.querySelector("td").innerText;
    const tick = row.querySelector("td:nth-child(2)").innerText.split("/");
    const doneToday = parseInt(tick[0]);
    const totalToday = parseInt(tick[1]);
    done += doneToday;
    total += totalToday;
    if (doneToday > bestScore) {
      bestScore = doneToday;
      bestDay = date;
    }
  });

  const percent = Math.round((done/total)*100);
  highlightBox.innerHTML =
    `📊 <b>${done}/${total}</b> mục đã hoàn thành (${percent}%).<br>
     🏆 Ngày tốt nhất: <b>${bestDay}</b> (${bestScore} mục tick)`;
}

function renderEmotionFlow() {
const ctx = document.getElementById("emotionFlowChart").getContext("2d");
const chartType = document.getElementById("chartType") 
  ? document.getElementById("chartType").value 
  : "line";
const scaleMode = document.getElementById("flowScale") 
  ? document.getElementById("flowScale").value 
  : "daily";
  const showEnergy = document.getElementById("toggleEnergy")?.checked ?? true;
  const showMood   = document.getElementById("toggleMood")?.checked ?? true;
  const showAura   = document.getElementById("toggleAura")?.checked ?? true;

  const allKeys = Object.keys(localStorage).filter(k => k.startsWith("progress_"));
  if (allKeys.length === 0) {
    ctx.font = "16px Arial";
    ctx.fillText("❌ Chưa có dữ liệu để vẽ Emotion Flow", 10, 50);
  document.getElementById("emotionFlowChart").style.display = "none";
    return;
  }

  // Gom dữ liệu thô theo ngày
  const rawDailyStats = {};
  allKeys.forEach(key => {
    const parts = key.replace("progress_", "").split("_");
    const group = parts[0];
    const date = parts.slice(1).join("_");
    const ticks = JSON.parse(localStorage.getItem(key) || "[]");
    const items = checklistData[group] || [];

    items.forEach((item, idx) => {
      if (ticks[idx]) {
        const val = checklistValues[item] || { energy: 0, mood: 0, aura: 0 };
        if (!rawDailyStats[date]) rawDailyStats[date] = { energy: 0, mood: 0, aura: 0 };
        rawDailyStats[date].energy += val.energy;
        rawDailyStats[date].mood += val.mood;
        rawDailyStats[date].aura += val.aura;
      }
    });
  // 📊 Sau khi vẽ xong chart, update Insight Box bằng dữ liệu của chính hàm này
  const insightBox = document.getElementById("historyHighlight");
  if (insightBox) {
    insightBox.innerHTML = generateInsights(rawDailyStats);
  }
  });

  // Hàm parse date
  function parseDate(dateStr) {
    const [d,m,y] = dateStr.split("/").map(Number);
    return new Date(y, m-1, d);
  }

  // Gom dữ liệu theo scale
  const statsByScale = {};
  Object.keys(rawDailyStats).forEach(date => {
    const d = parseDate(date);
    let key;
    if (scaleMode === "weekly") {
      const firstDay = new Date(d);
      const day = d.getDay() || 7;
      firstDay.setDate(d.getDate() - day + 1);
      key = `Tuần ${firstDay.getDate()}/${firstDay.getMonth()+1}`;
    } else if (scaleMode === "monthly") {
      key = `${d.getMonth()+1}/${d.getFullYear()}`;
    } else {
      key = date;
    }

    if (!statsByScale[key]) statsByScale[key] = { energy: 0, mood: 0, aura: 0 };
    statsByScale[key].energy += rawDailyStats[date].energy;
    statsByScale[key].mood += rawDailyStats[date].mood;
    statsByScale[key].aura += rawDailyStats[date].aura;
  });

  // Sort labels
  const labels = Object.keys(statsByScale).sort((a,b)=>{
    if (scaleMode === "daily") {
      const [da,ma,ya] = a.split("/").map(Number);
      const [db,mb,yb] = b.split("/").map(Number);
      return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
    }
    const numA = parseInt(a.split("/")[1] || 0);
    const numB = parseInt(b.split("/")[1] || 0);
    return numA - numB;
  });

  const energyData = labels.map(d => statsByScale[d].energy);
  const moodData   = labels.map(d => statsByScale[d].mood);
  const auraData   = labels.map(d => statsByScale[d].aura);

  // Xoá chart cũ
  if (window.emotionChart) window.emotionChart.destroy();

// 🎨 Gradient màu cho Energy/Mood/Aura
const gradientEnergy = ctx.createLinearGradient(0, 0, 0, 250);
gradientEnergy.addColorStop(0, "rgba(255, 215, 0, 0.6)");
gradientEnergy.addColorStop(1, "rgba(255, 255, 153, 0.2)");

const gradientMood = ctx.createLinearGradient(0, 0, 0, 250);
gradientMood.addColorStop(0, "rgba(77, 182, 226, 0.6)");
gradientMood.addColorStop(1, "rgba(179, 229, 252, 0.2)");

const gradientAura = ctx.createLinearGradient(0, 0, 0, 250);
gradientAura.addColorStop(0, "rgba(179, 136, 235, 0.6)");
gradientAura.addColorStop(1, "rgba(233, 215, 254, 0.2)");

  // Build dataset động theo toggle
  const datasets = [];
  if (showEnergy) {
  datasets.push({
    label: "⚡ Energy",
    data: energyData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientEnergy : "rgba(255,215,0,0.5)",
    borderColor: "#FFD700",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}
if (showMood) {
  datasets.push({
    label: "😊 Mood",
    data: moodData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientMood : "rgba(77,182,226,0.5)",
    borderColor: "#4DB6E2",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}
if (showAura) {
  datasets.push({
    label: "✨ Aura",
    data: auraData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientAura : "rgba(179,136,235,0.5)",
    borderColor: "#B388EB",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}

  // Render chart
  document.getElementById("emotionFlowChart").style.display = "block";
  window.emotionChart = new Chart(ctx, {
    type: chartType,
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
scales: (chartType === "radar") ? {} : {
  x: { stacked: chartType === "bar", title: { display: true, text: scaleMode === "daily" ? "Ngày" : (scaleMode === "weekly" ? "Tuần" : "Tháng") }},
  y: { stacked: chartType === "bar", beginAtZero: true, title: { display: true, text: "Điểm" }}
      }
    }
  });
  // 🎬 Cinematic: Chart fade-in khi render xong
const chartCanvas = document.getElementById("emotionFlowChart");

// reset để lần render mới có hiệu ứng fade
chartCanvas.classList.remove("chart-loaded");
setTimeout(() => chartCanvas.classList.add("chart-loaded"), 50);
}

function generateInsights(rawDailyStats) {
  const dates = Object.keys(rawDailyStats).sort((a,b) => {
    const [da,ma,ya] = a.split("/").map(Number);
    const [db,mb,yb] = b.split("/").map(Number);
    return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
  });

  if (dates.length === 0) return "❌ Không có dữ liệu để nhận xét.";

  let insights = [];

  // 📊 Tìm ngày cao nhất & thấp nhất cho từng chỉ số
  let maxEnergy = { date: "", value: -Infinity };
  let minEnergy = { date: "", value: Infinity };
  let maxMood = { date: "", value: -Infinity };
  let minMood = { date: "", value: Infinity };
  let maxAura = { date: "", value: -Infinity };
  let minAura = { date: "", value: Infinity };

  dates.forEach(date => {
    const stats = rawDailyStats[date];
    if (stats.energy > maxEnergy.value) { maxEnergy = { date, value: stats.energy }; }
    if (stats.energy < minEnergy.value) { minEnergy = { date, value: stats.energy }; }
    if (stats.mood > maxMood.value) { maxMood = { date, value: stats.mood }; }
    if (stats.mood < minMood.value) { minMood = { date, value: stats.mood }; }
    if (stats.aura > maxAura.value) { maxAura = { date, value: stats.aura }; }
    if (stats.aura < minAura.value) { minAura = { date, value: stats.aura }; }
  });

  insights.push(`📆 <b>${maxMood.date}</b> là ngày <b>Mood</b> cao nhất (${maxMood.value} điểm).`);
  insights.push(`✨ <b>${maxAura.date}</b> có <b>Aura</b> sáng nhất (${maxAura.value} điểm).`);
  insights.push(`⚡ <b>${maxEnergy.date}</b> đạt <b>Energy</b> đỉnh (${maxEnergy.value} điểm).`);

  // 📉 Kiểm tra biến động
  let drops = [];
  for (let i = 1; i < dates.length; i++) {
    const prev = rawDailyStats[dates[i-1]];
    const curr = rawDailyStats[dates[i]];

    if (prev.energy - curr.energy >= 5) {
      drops.push(`⚡ Energy giảm mạnh ${prev.energy - curr.energy} điểm vào ngày ${dates[i]}.`);
    }
    if (prev.mood - curr.mood >= 5) {
      drops.push(`😊 Mood tụt ${prev.mood - curr.mood} điểm vào ngày ${dates[i]}.`);
    }
    if (prev.aura - curr.aura >= 5) {
      drops.push(`✨ Aura mờ đi ${prev.aura - curr.aura} điểm vào ngày ${dates[i]}.`);
    }
  }

  if (drops.length > 0) {
    insights.push("<br><b>⚠ Biến động đáng chú ý:</b><br>" + drops.join("<br>"));
  } else {
    insights.push("<br>✅ Không có biến động lớn – trạng thái khá ổn định.");
  }

  return insights.join("<br>");
}

document.addEventListener("DOMContentLoaded", () => {
  const flowScaleSelect = document.getElementById("flowScale");
  if (flowScaleSelect) {
    flowScaleSelect.addEventListener("change", renderEmotionFlow);
  }

  const chartTypeSelect = document.getElementById("chartType");
  if (chartTypeSelect) {
    chartTypeSelect.addEventListener("change", renderEmotionFlow);
  }

  ["toggleEnergy","toggleMood","toggleAura"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", renderEmotionFlow);
  });
});

function syncCompareChart() {
  // Lắng nghe tick checklist ở chế độ 1 nhóm và update chart nếu đang mở multi-chart
  document.querySelectorAll('#checklist-form input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      if (selectedGroups.length > 1) {
        renderCompareChart(selectedGroups);
      }
    });
  });
}

  // --- Dữ liệu File JSON ---
function exportDataJSON() {
  let data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("progress_") || key === "simStats") { 
      data[key] = JSON.parse(localStorage.getItem(key));
    }
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-data.json";
  link.click();
}
</script>

<script>
const OPENAI_API_KEY = "...";   // ← dán API key GPT của em vào đây


let lastCall = 0;

async function talosReply(userMessage) {
  // 👉 TẠM DỪNG API (comment toàn bộ fetch):
  // const response = await fetch("https://api.openai.com/v1/chat/completions", {
  //   method: "POST",
  //   headers: {
  //     "Content-Type": "application/json",
  //     "Authorization": "Bearer " + OPENAI_API_KEY
  //   },
  //   body: JSON.stringify({
  //     model: "gpt-3.5-turbo",
  //     messages: [
  //       { role: "system", content: "Bạn là Talos..." },
  //       { role: "user", content: userMessage }
  //     ]
  //   })
  // });

  // const data = await response.json();
  // if (!data.choices || !data.choices[0]) {
  //   console.error("API Error:", data);
  //   return "⚠️ API bị quá tải hoặc key đang bị giới hạn (429). Em thử tick chậm hơn hoặc đổi model nhé.";
  // }

  // 👉 TRẢ LỜI GIẢ LẬP
  return "🤖 [TẠM DỪNG API] Talos Coach chưa kết nối GPT. Tick checklist vẫn ghi nhận.";
}

</script>
<!-- 
<div id="talos-chat" style="
     position: fixed;
     bottom: 20px;
     right: 20px;
     width: 300px;
     height: 400px;
     background: #fff;
     border: 1px solid #ccc;
     border-radius: 8px;
     box-shadow: 0 2px 8px rgba(0,0,0,0.2);
     overflow-y: auto;
     padding: 10px;
     font-family: Arial, sans-serif;">
   <strong>Talos Coach</strong>
   <div id="talos-messages"></div>
</div>-->
</body>
</html>
