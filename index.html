<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Web ÄÃ¡nh GiÃ¡ Checklist</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f8fa; margin: 0; padding: 30px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    h2 { color: #333; margin-top: 0; }
    h3 { color: #4caf50; margin-top: 30px; }
    label { display: block; margin: 8px 0; }
    select, button, #datePicker { padding: 8px 12px; font-size: 16px; margin-bottom: 10px; }
    #datePicker { border: 1px solid #ccc; border-radius: 8px; font-family: 'Segoe UI', Roboto, sans-serif; background-repeat: no-repeat; background-position: right 10px center; background-size: 16px 16px; padding-right: 32px; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%85%3C/text%3E%3C/svg%3E"); }
    #datePicker:hover, #datePicker:focus { border-color: #4CAFEF; outline: none; }
button { background-color: #4caf50; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    button:hover { background-color: #43a047; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #c8e6c9; }
    .result { margin-top: 20px; font-size: 18px; font-weight: bold; }
    .hidden { display: none; }
    label.checked { background-color: #e0ffe0; color: #2e7d32; animation: fade-in 0.3s; }
    .flatpickr-day.complete { background-color: #b2f2bb; color: #000; }
    .flatpickr-day.incomplete { background-color: #ffe6e6; color: #000; }
    #compareChart { max-height: 300px; }
    .progress { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
    .progress div { height: 100%; background-color: #4caf50; text-align: center; color: #fff; line-height: 20px; font-weight: bold; }
    .actions { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .date-picker { padding: 8px; border: 1px solid #ccc; border-radius: 8px; transition: border-color 0.2s; }
    .date-picker:hover, .date-picker:focus { border-color: #4CAFEF; outline: none; }
    .action-btn { background-color: #4CAF50; color: #fff; padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; margin-right: 8px; }
    .action-btn:hover { background-color: #43A047; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
    .actions .action-btn:last-child { margin-right: 0; }
    .bars { display: flex; gap: 10px; margin-bottom: 20px; }
    .bar { flex: 1; background: #eee; border-radius: 6px; position: relative; height: 24px; margin: 0 5px; }
    .bar span { position: absolute; left: 8px; top: 0; font-size: 12px; color: #000; line-height: 24px; z-index: 2; }
    .fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
    #energyBar { background: #FFD700; }
    #moodBar { background: #4DB6E2; }
    #auraBar { background: #B388EB; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
#chainHighlightBox {
  border: 2px solid #b2dfdb;
  margin-top: 10px;
  margin-bottom: 12px;
  min-height: 38px;
  padding: 8px 12px;
  transition: background 0.3s, border 0.3s, box-shadow 0.3s;
}
.chain-highlight {
  /* giá»¯ láº¡i class cho hiá»‡u á»©ng cÅ© náº¿u cÃ³ */
}
#flowScale {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 15px;
  margin-bottom: 10px;
}
/* ğŸ¬ Step 5: Cinematic Flow */

/* Hiá»‡u á»©ng fade, pulse, float */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes pulseGlow {
  0% { box-shadow: 0 0 0 rgba(76,175,80, 0.4); }
  50% { box-shadow: 0 0 18px rgba(76,175,80, 0.2); }
  100% { box-shadow: 0 0 0 rgba(76,175,80, 0.4); }
}
@keyframes floatBar {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

/* Thanh bar Ä‘ung Ä‘Æ°a */
.bars .fill {
  animation: floatBar 3.5s ease-in-out infinite;
  transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
}

/* Checklist tick cinematic */
label.checked {
  background-color: #e0ffe0;
  color: #2e7d32;
  animation: fadeSlideIn 0.4s ease-out;
  transition: transform 0.2s;
}
label.checked:hover {
  transform: scale(1.02);
}

/* Checklist hover highlight */
#checklist-form label:hover {
  background: #f1fff1;
  transform: translateX(2px);
  transition: transform 0.2s;
}

/* Modal cinematic */
.modal-content {
  animation: fadeSlideIn 0.5s ease-out;
}

/* Chart load fade-in */
#emotionFlowChart {
  opacity: 0;
  transition: opacity 0.8s ease;
}
.chart-loaded {
  opacity: 1 !important;
}

/* Motivation pulse */
#motivationBox span {
  animation: pulseGlow 2.5s ease-in-out infinite;
}
/* --- Fix modal content auto height --- */
#historyModalContent > canvas,
#historyModalContent > table,
#historyModalContent > div,
#historyModalContent > select {
  margin-bottom: 12px;
}

#historyModalContent {
  height: auto !important;
}

#emotionFlowChart {
  min-height: 60px;
  margin-top: 10px;
}
  </style>
</head>
<body>
  <div class="container">
    <h2>ÄÃ¡nh GiÃ¡ Checklist CÃ¡ NhÃ¢n</h2>
    <div class="bars">
      <div class="bar"><span>Energy âš¡</span><div class="fill" id="energyBar"></div></div>
      <div class="bar"><span>Mood ğŸ˜Š</span><div class="fill" id="moodBar"></div></div>
      <div class="bar"><span>Aura âœ¨</span><div class="fill" id="auraBar"></div></div>
    </div>
    <label for="category">Chá»n nhÃ³m checklist:</label>
    <select id="category" multiple>
      <option value="">-- Chá»n nhÃ³m --</option>
      <option value="chamCoThe">1. ğŸ‹ï¸ ChÄƒm CÆ¡ Thá»ƒ</option>
      <option value="chamNhaCua">2. ğŸ  ChÄƒm NhÃ  Cá»­a</option>
      <option value="dinhDuong">3. ğŸ Dinh DÆ°á»¡ng â€“ áº¨m Thá»±c</option>
      <option value="langPhi">4. ğŸ’° Kiá»ƒm SoÃ¡t LÃ£ng PhÃ­</option>
      <option value="aura">5. âœ¨ NÃ¢ng Táº§ng Aura</option>
      <option value="soThich">6. ğŸ­ Sá»Ÿ ThÃ­ch â€“ DÆ°á»¡ng KhÃ­</option>
      <option value="theDuc">7. ğŸƒ Thá»ƒ Dá»¥c â€“ CÆ¡ XÆ°Æ¡ng â€“ DÃ¡ng Form</option>
    </select>
    <canvas id="compareChart" class="hidden" style="margin-top:32px; background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(76,175,80,0.08);"></canvas>
    <div id="progressContainer" class="progress hidden"><div id="progressBar"></div></div>
    <div class="actions">
      <input type="text" id="datePicker" class="date-picker" readonly />
      <button class="action-btn" onclick="triggerImport()">Nháº­p dá»¯ liá»‡u</button>
      <input type="file" id="import-file" accept=".json" class="hidden" />
      <button class="action-btn" onclick="undoChange()">HoÃ n tÃ¡c</button>
      <button class="action-btn" onclick="exportDataJSON()">ğŸ’¾ Xuáº¥t dá»¯ liá»‡u JSON</button>
    </div>
    <h3 id="checklist-title"></h3>
    <div class="result checklist-summary" style="margin-bottom: 10px;">
      <div style="display:none"><span id="date"></span></div>
      <div><strong>ÄÃ£ hoÃ n thÃ nh:</strong> <span id="count">0</span>/<span id="total">0</span></div>
      <!-- <div><strong>Xáº¿p loáº¡i:</strong> <span id="rank" class="grade">ChÆ°a xÃ¡c Ä‘á»‹nh</span></div> -->
    </div>
    <form id="checklist-form"></form>
    <!-- NÃºt xem lá»‹ch sá»­ -->
    <div style="text-align:right; margin: 10px 0 0 0;">
      <button id="viewHistoryBtn" type="button" style="background:#1976d2; color:#fff; border-radius:6px; padding:7px 18px; font-size:16px; font-weight:500; border:none; cursor:pointer;">ğŸ“† Xem lá»‹ch sá»­</button>
    </div>
    <!-- Modal popup lá»‹ch sá»­ -->
<!-- Modal popup lá»‹ch sá»­ -->
<div id="historyModal" class="modal hidden" style="z-index:10000; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); display:none; align-items:center; justify-content:center;">
<div id="historyModalContent" style="background:#fff; border-radius:14px; max-width:900px; width:98vw; display:inline-block; max-height:90vh; overflow:auto; box-shadow:0 4px 32px rgba(25,118,210,0.13); padding:16px 20px; position:relative;">
    <button id="closeHistoryModal" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:26px; color:#888; cursor:pointer;">&times;</button>
    <h2 style="margin-top:0; color:#1976d2;">Lá»‹ch sá»­ Checklist</h2>

<!-- Biá»ƒu Ä‘á»“ Emotion/Performance Flow -->
<div style="margin-bottom: 10px;">
  <label for="flowScale"><b>Cháº¿ Ä‘á»™ hiá»ƒn thá»‹:</b></label>
  <select id="flowScale">
    <option value="daily" selected>Daily</option>
    <option value="weekly">Weekly</option>
    <option value="monthly">Monthly</option>
  </select>
</div>

<!-- Chart Type -->
<div style="margin-bottom: 10px;">
  <label for="chartType"><b>Loáº¡i biá»ƒu Ä‘á»“:</b></label>
  <select id="chartType">
    <option value="line" selected>Line</option>
    <option value="radar">Radar</option>
    <option value="bar">Stacked Bar</option>
  </select>
</div>

<!-- Layer Toggle (Energy/Mood/Aura) -->
<div id="layerToggleBox" style="margin:10px 0; display:flex; gap:14px; align-items:center;">
  <label><input type="checkbox" id="toggleEnergy" checked> âš¡ Energy</label>
  <label><input type="checkbox" id="toggleMood" checked> ğŸ˜Š Mood</label>
  <label><input type="checkbox" id="toggleAura" checked> âœ¨ Aura</label>
</div>

<canvas id="emotionFlowChart" style="width:100%; max-height:280px; margin-bottom:18px; background:#f8fafd; border-radius:10px;"></canvas>
        <!-- Highlight insight -->
        <div id="historyHighlight" style="margin-bottom:14px; font-size:15px; color:#333;"></div>
        <!-- Báº£ng lá»‹ch sá»­ -->
        <table id="historyTable" style="width:100%; border-collapse:collapse; margin-bottom:18px;">
          <thead>
            <tr style="background:#e3f2fd;">
              <th style="padding:7px 8px;">NgÃ y</th>
              <th style="padding:7px 8px;">ÄÃ£ tick</th>
              <th style="padding:7px 8px;">Chi tiáº¿t</th>
              <th>âŒ</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dá»¯ liá»‡u sáº½ render Ä‘á»™ng -->
          </tbody>
        </table>
        <!-- NÃºt export -->
        <div style="display:flex; gap:12px; align-items:center;">
          <button id="exportCSVBtn" type="button" style="background:#388e3c; color:#fff; border-radius:6px; padding:7px 18px; font-size:15px; font-weight:500; border:none; cursor:pointer;">â¬‡ Xuáº¥t CSV</button>
          <button id="exportXLSXBtn" type="button" style="background:#fbc02d; color:#333; border-radius:6px; padding:7px 18px; font-size:15px; font-weight:500; border:none; cursor:pointer;">â¬‡ Xuáº¥t Excel</button>
          <span id="exportMsg" style="margin-left:10px; color:#388e3c; font-size:15px;"></span>
        </div>
      </div>
    </div>
<script>
// --- Lá»‹ch sá»­ checklist: má»Ÿ/Ä‘Ã³ng modal ---
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('viewHistoryBtn');
  const modal = document.getElementById('historyModal');
  const closeBtn = document.getElementById('closeHistoryModal');

  // ğŸ‘‰ Nháº¥n nÃºt ğŸ“† -> hiá»‡n modal
btn.addEventListener('click', function() {
    modal.style.display = 'flex';

// ğŸ¬ Cinematic: Hiá»‡u á»©ng khi modal má»Ÿ
    document.getElementById('historyModalContent').style.animation = "fadeSlideIn 0.5s ease";
    renderHistoryTable();   // âœ… Gá»i hÃ m render báº£ng khi má»Ÿ modal
    updateHistoryHighlight();
if (window.emotionChart) window.emotionChart.destroy();
    renderEmotionFlow();  // âœ… 
});

// === XUáº¤T CSV ===
document.getElementById("exportCSVBtn").addEventListener("click", function () {
  let csv = "NgÃ y,ÄÃ£ tick,Chi tiáº¿t\n";
  document.querySelectorAll("#historyTable tbody tr").forEach(row => {
    let cols = row.querySelectorAll("td");
    let rowData = Array.from(cols).map(td => `"${td.innerText.replace(/\n/g, " ")}"`).join(",");
    csv += rowData + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-history.csv";
  link.click();
});

// === XUáº¤T EXCEL (dÃ¹ng HTML table thÃ nh file .xls) ===
document.getElementById("exportXLSXBtn").addEventListener("click", function () {
  let table = document.getElementById("historyTable").outerHTML;
  const blob = new Blob([table], { type: "application/vnd.ms-excel" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-history.xls";
  link.click();
});

  // ğŸ‘‰ Nháº¥n âŒ -> áº©n modal
  closeBtn.addEventListener('click', function() {
    modal.style.display = 'none';
  });

  // ğŸ‘‰ Click ra ngoÃ i overlay -> áº©n modal
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
});
</script>
    <!-- Chain Highlight Box -->
    <div id="chainHighlightBox" class="chain-highlight" style="min-height:38px; font-size:17px; font-weight:500; text-align:center; border-radius:10px; background:#f8fafd; box-shadow:0 2px 8px rgba(76,175,80,0.06); transition:all 0.3s; display:none;"></div>
    <!-- ÄÆ°a snippet lÃªn ngay dÆ°á»›i checklist-form, thÃªm hiá»‡u á»©ng Ä‘áº¹p -->
    <div id="snippet" class="snippet" style="margin-top:20px; min-height:32px; font-size:18px; color:#4caf50; font-weight:bold; text-align:center; transition: all 0.3s;"></div>
    <!-- Äá»™ng lá»±c ná»•i báº­t, hiá»‡u á»©ng thÃ nh tá»±u ÄÆ¯A XUá»NG DÆ¯á»šI CÃ™NG -->
    <div id="motivationBox" style="margin:18px 0 0 0; text-align:center; display:none;">
      <span id="motivation" style="display:inline-block; background:linear-gradient(90deg,#e0ffe0,#b2f2bb,#e0ffe0); color:#1b5e20; font-size:26px; font-weight:bold; border-radius:16px; padding:18px 40px; box-shadow:0 2px 16px rgba(76,175,80,0.12); letter-spacing:1.5px; transition:all 0.3s; border:2px solid #43a047;"></span>
    </div>
    <!-- ÄÆ°a story box xuá»‘ng dÆ°á»›i cÃ¹ng -->
    <div id="storyBox" style="display:none"><div id="storyMessages"></div></div>
    <!-- Modal thÃ nh tá»±u Ä‘áº¹p hÆ¡n -->
    <div id="milestoneModal" class="modal hidden" style="z-index:9999;">
      <div class="modal-content" style="text-align:center; padding:32px 24px; border-radius:16px; background:#fff; box-shadow:0 4px 32px rgba(76,175,80,0.15);">
        <div class="icon" style="font-size:48px; margin-bottom:12px;">ğŸ‰</div>
        <p id="milestoneText" style="font-size:22px; color:#388e3c; font-weight:bold; margin-bottom:16px;"></p>
        <button id="closeModal" style="background:#4caf50; color:#fff; border:none; border-radius:8px; padding:8px 24px; font-size:16px; cursor:pointer;">ÄÃ³ng</button>
        <div id="milestoneStoryMessages"></div>
      </div>
    </div>
   
    <script>

// âœ… HÃ m tráº£ vá» ngÃ y dáº¡ng dd/mm/yyyy
// âœ… HÃ m chuáº©n hÃ³a ngÃ y
function getSelectedDate() {
  const pickerValue = document.getElementById('datePicker')?.value;
  if (pickerValue) return pickerValue;

  const d = new Date();
  return d.getDate().toString().padStart(2, '0') + '/' +
         (d.getMonth() + 1).toString().padStart(2, '0') + '/' +
         d.getFullYear();
}

function getSafeDate() {
  return getSelectedDate().replace(/\//g, "-");
}

// âœ… HÃ m Ä‘á»•i / thÃ nh - Ä‘á»ƒ dÃ¹ng key localStorage
function getSafeDate() {
  return getSelectedDate().replace(/\//g, "-");
}

// --- Dá»¯ liá»‡u checklist cho tá»«ng nhÃ³m ---
const checklistData = {
  chamCoThe: [
    "Uá»‘ng Ä‘á»§ 1.5â€“2L nÆ°á»›c",
    "Rá»­a máº·t sÃ¡ng + tá»‘i",
    "Thoa lotion body",
    "Cháº£i tÃ³c â€“ xá»‹t dÆ°á»¡ng",
    "ÄÃ¡nh rÄƒng 2 láº§n/ngÃ y",
    "Táº©y trang/lau sáº¡ch máº·t",
    "LÃ m sáº¡ch mÃ´i â€“ dÆ°á»¡ng mÃ´i",
    "Táº¯m nÆ°á»›c áº¥m buá»•i tá»‘i",
    "DÆ°á»¡ng da body tá»‘i",
    "KÃ©o giÃ£n chÃ¢n/gáº­p bá»¥ng nháº¹"
  ],
  chamNhaCua: [
    "Xáº¿p chÄƒn gá»n sau khi ngá»§ dáº­y",
    "Rá»­a chÃ©n bÃ¡t trong ngÃ y",
    "QuÃ©t nhÃ /lau chÃ¹i Ä‘iá»ƒm báº©n",
    "KhÃ´ng Ä‘á»ƒ Ä‘á»“ lung tung dÆ°á»›i Ä‘áº¥t",
    "Dá»n Ä‘á»“ trÃªn bÃ n vá» Ä‘Ãºng chá»—",
    "Äá»• rÃ¡c (tá»‘i)"
  ],
  dinhDuong: [
    "1 cá»‘c nÆ°á»›c ngay sau ngá»§ dáº­y",
    "Uá»‘ng nÆ°á»›c 1.5â€“2L chia sÃ¡ng/chiá»u/tá»‘i",
    "2â€“3 bá»¯a chÃ­nh Ä‘á»§ cháº¥t",
    "1â€“2 bá»¯a phá»¥ nháº¹",
    "1 bá»¯a cÃ³ rau xanh lÃ¡",
    "1â€“2 bá»¯a cÃ³ trÃ¡i cÃ¢y",
    "1 bá»¯a protein tráº¯ng",
    "KhÃ´ng Ä‘á»ƒ quÃ¡ 6 tiáº¿ng khÃ´ng Äƒn",
    "KhÃ´ng Äƒn khuya sau 9h tá»‘i"
  ],
  langPhi: [
    "KhÃ´ng mua Ä‘á»“ khÃ´ng cáº§n thiáº¿t",
    "KhÃ´ng tiÃªu tiá»n cho thÃ³i quen xáº¥u",
    "Kiá»ƒm tra vÃ­ trÆ°á»›c khi ra ngoÃ i",
    "Ghi chÃº chi tiÃªu trong ngÃ y"
  ],
  aura: [
    "Thiá»n hoáº·c thá»Ÿ sÃ¢u 5 phÃºt",
    "Äá»c sÃ¡ch phÃ¡t triá»ƒn báº£n thÃ¢n",
    "Viáº¿t nháº­t kÃ½ cáº£m xÃºc",
    "Nghe nháº¡c thÆ° giÃ£n"
  ],
  soThich: [
    "Váº½/trang trÃ­/viáº¿t lÃ¡ch",
    "ChÆ¡i nháº¡c cá»¥ hoáº·c nghe nháº¡c",
    "Táº­p thá»ƒ thao nháº¹ nhÃ ng",
    "ChÄƒm sÃ³c cÃ¢y cáº£nh/thÃº cÆ°ng"
  ],
  theDuc: [
    "Khá»Ÿi Ä‘á»™ng 5 phÃºt",
    "Táº­p thá»ƒ dá»¥c Ã­t nháº¥t 15 phÃºt",
    "Äi bá»™ 5000 bÆ°á»›c trá»Ÿ lÃªn",
    "GiÃ£n cÆ¡ sau táº­p"
  ]
};

// --- Chain relations: mapping checklist items to their cause-effect chains ---
const chainRelations = {
  // ChÄƒm CÆ¡ Thá»ƒ
  "Uá»‘ng Ä‘á»§ 1.5â€“2L nÆ°á»›c": [
    { text: "CÆ¡ thá»ƒ Ä‘Æ°á»£c bÃ¹ nÆ°á»›c", positive: true },
    { text: "Tuáº§n hoÃ n tá»‘t hÆ¡n", positive: true },
    { text: "Da cÄƒng & sáº¡ch", positive: true },
    { text: "NÄƒng lÆ°á»£ng + táº­p trung", positive: true }
  ],
  "Rá»­a máº·t sÃ¡ng + tá»‘i": [
    { text: "Da sáº¡ch bá»¥i/dáº§u", positive: true },
    { text: "Giáº£m má»¥n & dá»‹ á»©ng", positive: true },
    { text: "Tá»± tin khi giao tiáº¿p", positive: true }
  ],
  "Thoa lotion body": [
    { text: "Da áº©m & má»m", positive: true },
    { text: "TrÃ¡nh khÃ´ ná»©t", positive: true },
    { text: "Cáº£m giÃ¡c dá»… chá»‹u", positive: true },
    { text: "Aura dá»‹u", positive: true }
  ],
  "Cháº£i tÃ³c â€“ xá»‹t dÆ°á»¡ng": [
    { text: "TÃ³c gá»n & bÃ³ng", positive: true },
    { text: "Ngoáº¡i hÃ¬nh chá»‰nh chu", positive: true },
    { text: "Tá»± tin hÆ¡n", positive: true }
  ],
  "ÄÃ¡nh rÄƒng 2 láº§n/ngÃ y": [
    { text: "HÆ¡i thá»Ÿ thÆ¡m & sáº¡ch", positive: true },
    { text: "Tá»± tin trÃ² chuyá»‡n", positive: true },
    { text: "Aura tá»‘t", positive: true }
  ],
  "Táº©y trang/lau sáº¡ch máº·t": [
    { text: "Lá»— chÃ¢n lÃ´ng sáº¡ch", positive: true },
    { text: "Giáº£m má»¥n", positive: true },
    { text: "Cáº£m giÃ¡c nháº¹ máº·t", positive: true }
  ],
  "LÃ m sáº¡ch mÃ´i â€“ dÆ°á»¡ng mÃ´i": [
    { text: "MÃ´i má»m & há»“ng", positive: true },
    { text: "GÆ°Æ¡ng máº·t tÆ°Æ¡i", positive: true },
    { text: "Tá»± tin", positive: true }
  ],
  "Táº¯m nÆ°á»›c áº¥m buá»•i tá»‘i": [
    { text: "Giáº£m cÄƒng cÆ¡ & stress", positive: true },
    { text: "Ngá»§ sÃ¢u hÆ¡n", positive: true },
    { text: "SÃ¡ng dáº­y tá»‰nh tÃ¡o", positive: true }
  ],
  "DÆ°á»¡ng da body tá»‘i": [
    { text: "Da má»m, má»‹n", positive: true },
    { text: "Cáº£m giÃ¡c 'chÄƒm sÃ³c báº£n thÃ¢n'", positive: true },
    { text: "Tá»± tin & dá»… chá»‹u", positive: true }
  ],
  "KÃ©o giÃ£n chÃ¢n/gáº­p bá»¥ng nháº¹": [
    { text: "Giáº£m Ä‘au cÆ¡ sau ngá»“i lÃ¢u", positive: true },
    { text: "LÆ°u thÃ´ng mÃ¡u", positive: true },
    { text: "DÃ¡ng form á»•n", positive: true }
  ],
  // ChÄƒm NhÃ  Cá»­a
  "Xáº¿p chÄƒn gá»n sau khi ngá»§ dáº­y": [
    { text: "GiÆ°á»ng gá»n gÃ ng", positive: true },
    { text: "KhÃ´ng gian sáº¡ch", positive: true },
    { text: "NÃ£o Ã­t rá»‘i", positive: true },
    { text: "Mood tá»‘t", positive: true }
  ],
  "Rá»­a chÃ©n bÃ¡t trong ngÃ y": [
    { text: "NhÃ  báº¿p sáº¡ch", positive: true },
    { text: "KhÃ´ng mÃ¹i hÃ´i", positive: true },
    { text: "TÃ¢m lÃ½ thoáº£i mÃ¡i", positive: true },
    { text: "Dá»… náº¥u Äƒn", positive: true }
  ],
  "QuÃ©t nhÃ /lau chÃ¹i Ä‘iá»ƒm báº©n": [
    { text: "KhÃ´ng gian sáº¡ch sáº½", positive: true },
    { text: "Aura nhÃ  'thá»Ÿ'", positive: true },
    { text: "TÃ¢m tráº¡ng nháº¹", positive: true }
  ],
  "KhÃ´ng Ä‘á»ƒ Ä‘á»“ lung tung dÆ°á»›i Ä‘áº¥t": [
    { text: "PhÃ²ng gá»n", positive: true },
    { text: "Giáº£m vÆ°á»›ng vÃ­u", positive: true },
    { text: "Cáº£m giÃ¡c kiá»ƒm soÃ¡t", positive: true }
  ],
  "Dá»n Ä‘á»“ trÃªn bÃ n vá» Ä‘Ãºng chá»—": [
    { text: "BÃ n sáº¡ch", positive: true },
    { text: "NÃ£o bá»›t loáº¡n", positive: true },
    { text: "Hiá»‡u suáº¥t há»c/lÃ m viá»‡c cao hÆ¡n", positive: true }
  ],
  "Äá»• rÃ¡c (tá»‘i)": [
    { text: "KhÃ´ng mÃ¹i hÃ´i, khÃ´ng kiáº¿n giÃ¡n", positive: true },
    { text: "KhÃ´ng gian 'sáº¡ch khÃ­'", positive: true }
  ],
  // Dinh DÆ°á»¡ng â€“ áº¨m Thá»±c
  "1 cá»‘c nÆ°á»›c ngay sau ngá»§ dáº­y": [
    { text: "Tháº£i Ä‘á»™c Ä‘Ãªm", positive: true },
    { text: "Há»‡ tiÃªu hÃ³a kÃ­ch hoáº¡t", positive: true },
    { text: "NÃ£o tá»‰nh", positive: true }
  ],
  "Uá»‘ng nÆ°á»›c 1.5â€“2L chia sÃ¡ng/chiá»u/tá»‘i": [
    { text: "Da áº©m & sáº¡ch", positive: true },
    { text: "Tháº­n khá»e", positive: true },
    { text: "NÄƒng lÆ°á»£ng Ä‘á»u", positive: true }
  ],
  "2â€“3 bá»¯a chÃ­nh Ä‘á»§ cháº¥t": [
    { text: "ÄÆ°á»ng huyáº¿t á»•n", positive: true },
    { text: "NÄƒng lÆ°á»£ng bá»n", positive: true },
    { text: "KhÃ´ng uá»ƒ oáº£i", positive: true }
  ],
  "1â€“2 bá»¯a phá»¥ nháº¹": [
    { text: "KhÃ´ng Ä‘Ã³i gáº¯t", positive: true },
    { text: "Kiá»ƒm soÃ¡t Äƒn váº·t", positive: true },
    { text: "CÃ¢n náº·ng á»•n Ä‘á»‹nh", positive: true }
  ],
  "1 bá»¯a cÃ³ rau xanh lÃ¡": [
    { text: "Cháº¥t xÆ¡", positive: true },
    { text: "Há»‡ tiÃªu hÃ³a khá»e", positive: true },
    { text: "Da Ä‘áº¹p", positive: true }
  ],
  "1â€“2 bá»¯a cÃ³ trÃ¡i cÃ¢y": [
    { text: "Vitamin", positive: true },
    { text: "Miá»…n dá»‹ch tá»‘t", positive: true },
    { text: "Cáº£m giÃ¡c tÆ°Æ¡i má»›i", positive: true }
  ],
  "1 bá»¯a protein tráº¯ng": [
    { text: "CÆ¡ báº¯p phá»¥c há»“i", positive: true },
    { text: "Giáº£m má»‡t", positive: true },
    { text: "Ngá»§ tá»‘t hÆ¡n", positive: true }
  ],
  "KhÃ´ng Ä‘á»ƒ quÃ¡ 6 tiáº¿ng khÃ´ng Äƒn": [
    { text: "ÄÆ°á»ng huyáº¿t khÃ´ng rá»›t", positive: true },
    { text: "KhÃ´ng chÃ³ng máº·t", positive: true },
    { text: "NÄƒng suáº¥t á»•n", positive: true }
  ],
  "KhÃ´ng Äƒn khuya sau 9h tá»‘i": [
    { text: "Dáº¡ dÃ y nghá»‰", positive: true },
    { text: "Ngá»§ ngon hÆ¡n", positive: true },
    { text: "SÃ¡ng tá»‰nh", positive: true }
  ],
  // Kiá»ƒm SoÃ¡t LÃ£ng PhÃ­
  "KhÃ´ng mua Ä‘á»“ khÃ´ng cáº§n thiáº¿t": [
    { text: "Giá»¯ tiá»n", positive: true },
    { text: "Giáº£m Ã¡p lá»±c tÃ i chÃ­nh", positive: true },
    { text: "Äáº§u Ã³c nháº¹", positive: true }
  ],
  "KhÃ´ng tiÃªu tiá»n cho thÃ³i quen xáº¥u": [
    { text: "Ãt cáº£m giÃ¡c tá»™i lá»—i", positive: true },
    { text: "Tinh tháº§n á»•n Ä‘á»‹nh", positive: true }
  ],
  "Kiá»ƒm tra vÃ­ trÆ°á»›c khi ra ngoÃ i": [
    { text: "Kiá»ƒm soÃ¡t chi tiÃªu", positive: true },
    { text: "Háº¡n cháº¿ mua impulsive", positive: true }
  ],
  "Ghi chÃº chi tiÃªu trong ngÃ y": [
    { text: "NhÃ¬n rÃµ dÃ²ng tiá»n", positive: true },
    { text: "Quáº£n lÃ½ tá»‘t", positive: true },
    { text: "Ãt stress tÃ i chÃ­nh", positive: true }
  ],
  // NÃ¢ng Táº§ng Aura
  "Thiá»n hoáº·c thá»Ÿ sÃ¢u 5 phÃºt": [
    { text: "Giáº£m stress", positive: true },
    { text: "NÃ£o tÄ©nh", positive: true },
    { text: "Aura sÃ¡ng", positive: true }
  ],
  "Äá»c sÃ¡ch phÃ¡t triá»ƒn báº£n thÃ¢n": [
    { text: "TÆ° duy má»Ÿ", positive: true },
    { text: "Tá»± tin", positive: true },
    { text: "Aura máº¡nh", positive: true }
  ],
  "Viáº¿t nháº­t kÃ½ cáº£m xÃºc": [
    { text: "Xáº£ cáº£m xÃºc", positive: true },
    { text: "CÃ¢n báº±ng", positive: true },
    { text: "Aura tÄ©nh", positive: true }
  ],
  "Nghe nháº¡c thÆ° giÃ£n": [
    { text: "NÃ£o reset", positive: true },
    { text: "Thoáº£i mÃ¡i", positive: true },
    { text: "Aura dá»‹u", positive: true }
  ],
  // Sá»Ÿ ThÃ­ch â€“ DÆ°á»¡ng KhÃ­
  "Váº½/trang trÃ­/viáº¿t lÃ¡ch": [
    { text: "KÃ­ch thÃ­ch sÃ¡ng táº¡o", positive: true },
    { text: "TÃ¢m an", positive: true },
    { text: "Aura nghá»‡", positive: true }
  ],
  "ChÆ¡i nháº¡c cá»¥ hoáº·c nghe nháº¡c": [
    { text: "Endorphin", positive: true },
    { text: "Vui váº»", positive: true },
    { text: "Aura sÃ¡ng", positive: true }
  ],
  "Táº­p thá»ƒ thao nháº¹ nhÃ ng": [
    { text: "CÆ¡ thá»ƒ linh hoáº¡t", positive: true },
    { text: "Mood tá»‘t", positive: true },
    { text: "Aura khá»e", positive: true }
  ],
  "ChÄƒm sÃ³c cÃ¢y cáº£nh/thÃº cÆ°ng": [
    { text: "NuÃ´i dÆ°á»¡ng cáº£m xÃºc", positive: true },
    { text: "Aura áº¥m", positive: true }
  ],
  // Thá»ƒ Dá»¥c â€“ CÆ¡ XÆ°Æ¡ng â€“ DÃ¡ng Form
  "Khá»Ÿi Ä‘á»™ng 5 phÃºt": [
    { text: "Giáº£m nguy cÆ¡ cháº¥n thÆ°Æ¡ng", positive: true },
    { text: "Táº­p hiá»‡u quáº£", positive: true }
  ],
  "Táº­p thá»ƒ dá»¥c Ã­t nháº¥t 15 phÃºt": [
    { text: "Endorphin", positive: true },
    { text: "NÄƒng lÆ°á»£ng tÄƒng", positive: true },
    { text: "Ngá»§ sÃ¢u", positive: true }
  ],
  "Äi bá»™ 5000 bÆ°á»›c trá»Ÿ lÃªn": [
    { text: "Tim máº¡ch & phá»•i khá»e", positive: true },
    { text: "LÆ°u thÃ´ng mÃ¡u", positive: true },
    { text: "Mood tá»‘t", positive: true }
  ],
  "GiÃ£n cÆ¡ sau táº­p": [
    { text: "CÆ¡ phá»¥c há»“i", positive: true },
    { text: "Giáº£m Ä‘au", positive: true },
    { text: "Táº­p Ä‘á»u hÆ¡n", positive: true }
  ]
};



// --- Cáº­p nháº­t chain highlight box ---
function updateChainHighlight(item, checked, anyChecked) {
  const box = document.getElementById('chainHighlightBox');
  if (!box) return;
  if (!anyChecked) {
    box.style.display = 'none';
    box.textContent = '';
    return;
  }
  let chain = chainRelations[item];
  if (!chain) {
    box.textContent = '';
    box.style.background = '#f8fafd';
    box.style.display = '';
    return;
  }
  // Náº¿u bá» tick, hiá»ƒn thá»‹ chuá»—i tiÃªu cá»±c (Ä‘áº£o ngÆ°á»£c, mÃ u Ä‘á»)
  if (!checked) {
    box.innerHTML = chain.map(e => `<span style='color:#e53935;'>${e.text}</span>`).reverse().join(' <span style="color:#e53935;font-weight:bold;">â†’</span> ');
    box.style.background = '#fff3f3';
  } else {
    box.innerHTML = chain.map(e => `<span style='color:#388e3c;'>${e.text}</span>`).join(' <span style="color:#388e3c;font-weight:bold;">â†’</span> ');
    box.style.background = '#e8f5e9';
  }
  box.style.display = '';
}

// HÃ m an toÃ n cho localStorage (Ä‘á»•i / thÃ nh -)
function getSafeDate() {
  return getSelectedDate().replace(/\//g,"-");
}
const checklistValues = {
  // ChÄƒm CÆ¡ Thá»ƒ
  "Uá»‘ng Ä‘á»§ 1.5â€“2L nÆ°á»›c": { energy: 2, mood: 1, aura: 1 },
  "Rá»­a máº·t sÃ¡ng + tá»‘i": { energy: 1, mood: 1, aura: 1 },
  "Thoa lotion body": { energy: 1, mood: 1, aura: 1 },
  "Cháº£i tÃ³c â€“ xá»‹t dÆ°á»¡ng": { energy: 1, mood: 1, aura: 1 },
  "ÄÃ¡nh rÄƒng 2 láº§n/ngÃ y": { energy: 1, mood: 1, aura: 1 },
  "Táº©y trang/lau sáº¡ch máº·t": { energy: 1, mood: 1, aura: 1 },
  "LÃ m sáº¡ch mÃ´i â€“ dÆ°á»¡ng mÃ´i": { energy: 1, mood: 1, aura: 1 },
  "Táº¯m nÆ°á»›c áº¥m buá»•i tá»‘i": { energy: 1, mood: 1, aura: 1 },
  "DÆ°á»¡ng da body tá»‘i": { energy: 1, mood: 1, aura: 1 },
  "KÃ©o giÃ£n chÃ¢n/gáº­p bá»¥ng nháº¹": { energy: 1, mood: 1, aura: 1 },
  // ChÄƒm NhÃ  Cá»­a
  "Xáº¿p chÄƒn gá»n sau khi ngá»§ dáº­y": { energy: 1, mood: 1, aura: 1 },
  "Rá»­a chÃ©n bÃ¡t trong ngÃ y": { energy: 1, mood: 1, aura: 1 },
  "QuÃ©t nhÃ /lau chÃ¹i Ä‘iá»ƒm báº©n": { energy: 1, mood: 1, aura: 1 },
  "KhÃ´ng Ä‘á»ƒ Ä‘á»“ lung tung dÆ°á»›i Ä‘áº¥t": { energy: 1, mood: 1, aura: 1 },
  "Dá»n Ä‘á»“ trÃªn bÃ n vá» Ä‘Ãºng chá»—": { energy: 1, mood: 1, aura: 1 },
  "Äá»• rÃ¡c (tá»‘i)": { energy: 1, mood: 1, aura: 1 },
  // Dinh DÆ°á»¡ng â€“ áº¨m Thá»±c
  "1 cá»‘c nÆ°á»›c ngay sau ngá»§ dáº­y": { energy: 2, mood: 1, aura: 1 },
  "Uá»‘ng nÆ°á»›c 1.5â€“2L chia sÃ¡ng/chiá»u/tá»‘i": { energy: 2, mood: 1, aura: 1 },
  "2â€“3 bá»¯a chÃ­nh Ä‘á»§ cháº¥t": { energy: 2, mood: 2, aura: 1 },
  "1â€“2 bá»¯a phá»¥ nháº¹": { energy: 2, mood: 2, aura: 1 },
  "1 bá»¯a cÃ³ rau xanh lÃ¡": { energy: 2, mood: 1, aura: 1 },
  "1â€“2 bá»¯a cÃ³ trÃ¡i cÃ¢y": { energy: 2, mood: 2, aura: 1 },
  "1 bá»¯a protein tráº¯ng": { energy: 3, mood: 1, aura: 1 },
  "KhÃ´ng Ä‘á»ƒ quÃ¡ 6 tiáº¿ng khÃ´ng Äƒn": { energy: 1, mood: 1, aura: 1 },
  "KhÃ´ng Äƒn khuya sau 9h tá»‘i": { energy: 2, mood: 1, aura: 1 },
  // Kiá»ƒm soÃ¡t lÃ£ng phÃ­
  "KhÃ´ng mua Ä‘á»“ khÃ´ng cáº§n thiáº¿t": { energy: 0, mood: 0, aura: 5 },
  "KhÃ´ng tiÃªu tiá»n cho thÃ³i quen xáº¥u": { energy: 0, mood: 0, aura: 5 },
  "Kiá»ƒm tra vÃ­ trÆ°á»›c khi ra ngoÃ i": { energy: 0, mood: 0, aura: 2 },
  "Ghi chÃº chi tiÃªu trong ngÃ y": { energy: 0, mood: 0, aura: 3 },
  // Aura
  "Thiá»n hoáº·c thá»Ÿ sÃ¢u 5 phÃºt": { energy: 0, mood: 5, aura: 5 },
  "Äá»c sÃ¡ch phÃ¡t triá»ƒn báº£n thÃ¢n": { energy: 0, mood: 3, aura: 5 },
  "Viáº¿t nháº­t kÃ½ cáº£m xÃºc": { energy: 0, mood: 4, aura: 4 },
  "Nghe nháº¡c thÆ° giÃ£n": { energy: 0, mood: 5, aura: 3 },
  // Sá»Ÿ thÃ­ch
  "Váº½/trang trÃ­/viáº¿t lÃ¡ch": { energy: 0, mood: 4, aura: 4 },
  "ChÆ¡i nháº¡c cá»¥ hoáº·c nghe nháº¡c": { energy: 0, mood: 5, aura: 3 },
  "Táº­p thá»ƒ thao nháº¹ nhÃ ng": { energy: 0, mood: 3, aura: 2 },
  "ChÄƒm sÃ³c cÃ¢y cáº£nh/thÃº cÆ°ng": { energy: 0, mood: 4, aura: 3 },
  // Thá»ƒ dá»¥c
  "Khá»Ÿi Ä‘á»™ng 5 phÃºt": { energy: 5, mood: 0, aura: 0 },
  "Táº­p thá»ƒ dá»¥c Ã­t nháº¥t 15 phÃºt": { energy: 10, mood: 0, aura: 0 },
  "Äi bá»™ 5000 bÆ°á»›c trá»Ÿ lÃªn": { energy: 8, mood: 0, aura: 0 },
  "GiÃ£n cÆ¡ sau táº­p": { energy: 2, mood: 0, aura: 0 }
};


const storyBank = [
  "Má»™t lÃ n khÃ­ nháº¹ lan ra quanh báº¡n.",
  "Báº¡n tháº¥y cÆ¡ thá»ƒ mÃ¬nh áº¥m lÃªn má»™t chÃºt.",
  "Báº¡n cáº£m tháº¥y tinh tháº§n pháº¥n cháº¥n hÆ¡n.",
  "Báº¡n vá»«a hoÃ n thÃ nh má»™t bÆ°á»›c nhá» cho báº£n thÃ¢n.",
  "Báº¡n Ä‘Ã£ chÄƒm sÃ³c tá»‘t cho chÃ­nh mÃ¬nh hÃ´m nay."
];
const milestoneBank = [
  "CÆ¡ thá»ƒ nÃ y nhÆ° vá»«a Ä‘Æ°á»£c reset.",
  "CÄƒn phÃ²ng nÃ y giá» thá»Ÿ cÃ¹ng báº¡n.",
  "Báº¡n Ä‘Ã£ Ä‘áº¡t má»™t cá»™t má»‘c má»›i!",
  "Báº¡n xá»©ng Ä‘Ã¡ng vá»›i thÃ nh tá»±u nÃ y!"
];

// --- Biáº¿n toÃ n cá»¥c ---
let selectedGroups = [];
let currentGroup = "";
let choicesInstance;
let compareChart;
const categorySelect = document.getElementById('category');

// --- Thanh tráº¡ng thÃ¡i ---
// --- TÃ­nh láº¡i tá»•ng Ä‘iá»ƒm energy, mood, aura cho nhÃ³m hiá»‡n táº¡i ---
function recalcStatsForCurrentGroup() {
  stats.energy = 0;
  stats.mood = 0;
  stats.aura = 0;
  if (!currentGroup || !checklistData[currentGroup]) {
    updateBars();
    saveStats();
    return;
  }
  const items = checklistData[currentGroup];
  const values = JSON.parse(localStorage.getItem(`progress_${currentGroup}_${getSafeDate()}`) || '[]');
  for (let i = 0; i < items.length; i++) {
    if (values[i]) {
      const val = checklistValues[items[i]] || { energy: 0, mood: 0, aura: 0 };
      stats.energy += val.energy;
      stats.mood += val.mood;
      stats.aura += val.aura;
    }
  }
  updateBars();
  saveStats();
}
const stats = { energy: 0, mood: 0, aura: 0 };
let statsDate = ""; // ngÃ y hiá»‡n táº¡i cá»§a thanh bar

function loadStats() {
  // Láº¥y tráº¡ng thÃ¡i thanh bar tá»« localStorage
  const saved = JSON.parse(localStorage.getItem('simStats') || '{}');
  if (saved && saved.date === getSafeDate()) {
    stats.energy = saved.energy || 0;
    stats.mood = saved.mood || 0;
    stats.aura = saved.aura || 0;
    statsDate = saved.date;
  } else {
    stats.energy = 0;
    stats.mood = 0;
    stats.aura = 0;
    statsDate = getSafeDate();
  }
  updateBars();
}

function saveStats(){
  const today = getSafeDate();
  localStorage.setItem('simStats', JSON.stringify({
    energy: stats.energy,
    mood: stats.mood,
    aura: stats.aura,
    date: today
  }));
}

function updateBars(){
  // TÃ­nh tá»•ng tá»‘i Ä‘a cho tá»«ng loáº¡i (energy, mood, aura) dá»±a trÃªn checklist hiá»‡n táº¡i
  let maxEnergy = 0, maxMood = 0, maxAura = 0;
  if (currentGroup && checklistData[currentGroup]) {
    const items = checklistData[currentGroup];
    for (let i = 0; i < items.length; i++) {
      const val = checklistValues[items[i]] || { energy: 0, mood: 0, aura: 0 };
      maxEnergy += val.energy;
      maxMood += val.mood;
      maxAura += val.aura;
    }
  } else {
    // Náº¿u khÃ´ng cÃ³ nhÃ³m nÃ o, máº·c Ä‘á»‹nh max lÃ  100 Ä‘á»ƒ bar khÃ´ng bá»‹ NaN
    maxEnergy = maxMood = maxAura = 100;
  }
  // Náº¿u max = 0 thÃ¬ bar sáº½ khÃ´ng hiá»‡n (áº©n fill)
  const energyBar = document.getElementById('energyBar');
  const moodBar = document.getElementById('moodBar');
  const auraBar = document.getElementById('auraBar');
  const energyPercent = (maxEnergy > 0) ? Math.round((stats.energy / maxEnergy) * 100) : 0;
  const moodPercent = (maxMood > 0) ? Math.round((stats.mood / maxMood) * 100) : 0;
  const auraPercent = (maxAura > 0) ? Math.round((stats.aura / maxAura) * 100) : 0;
  energyBar.style.width = energyPercent > 0 ? energyPercent + '%' : '0%';
  moodBar.style.width = moodPercent > 0 ? moodPercent + '%' : '0%';
  auraBar.style.width = auraPercent > 0 ? auraPercent + '%' : '0%';
  energyBar.style.background = energyPercent > 0 ? "#FFD700" : "transparent";
  moodBar.style.background = moodPercent > 0 ? "#4DB6E2" : "transparent";
  auraBar.style.background = auraPercent > 0 ? "#B388EB" : "transparent";
}

// --- Hiá»‡u á»©ng story ---
function fadeSnippet(text){
  const snippetDiv = document.getElementById('snippet');
  snippetDiv.style.opacity = 0;
  snippetDiv.style.transform = "translateY(20px) scale(0.95)";
  setTimeout(()=>{
    snippetDiv.textContent = text;
    snippetDiv.style.opacity = 1;
    snippetDiv.style.transform = "translateY(0) scale(1.05)";
    setTimeout(()=>{ snippetDiv.style.transform = "translateY(0) scale(1)"; }, 200);
  }, 80);
}

// --- Modal thÃ nh tá»±u ---
// --- Hiá»ƒn thá»‹ modal thÃ nh tá»±u khi hoÃ n thÃ nh checklist ---
function showMilestone(text) {
  milestoneText.textContent = text;
  modal.classList.remove('hidden');
}
const modal = document.getElementById('milestoneModal');
const milestoneText = document.getElementById('milestoneText');
document.getElementById('closeModal').addEventListener('click',()=>modal.classList.add('hidden'));

// --- Render checklist ---
function renderChecklist(group) {
  const checklistDiv = document.getElementById('checklist-form');
  checklistDiv.innerHTML = '';


// ğŸ¬ Cinematic: checklist fade-in
checklistDiv.style.opacity = 0;
setTimeout(() => {
  checklistDiv.style.transition = "opacity 0.5s ease";
  checklistDiv.style.opacity = 1;
}, 50);

  fadeSnippet('');
  const chainBox = document.getElementById('chainHighlightBox');
  const motivationBox = document.getElementById('motivationBox');
  if (!group || !checklistData[group]) {
    chainBox.style.display = 'none';
    motivationBox.style.display = 'none';
    updateSummary(0, 0, "ChÆ°a xÃ¡c Ä‘á»‹nh", "", false);
    recalcStatsForCurrentGroup();
    return;
  }
  const items = checklistData[group];
  let currentValues = JSON.parse(localStorage.getItem(`progress_${group}_${getSafeDate()}`) || '[]');
  if (currentValues.length !== items.length) currentValues = items.map(() => false);
  // Kiá»ƒm tra cÃ³ má»¥c nÃ o Ä‘Ã£ tick chÆ°a
  let anyChecked = currentValues.some(Boolean);
  if (!anyChecked) {
    chainBox.style.display = 'none';
    motivationBox.style.display = 'none';
  }
  items.forEach((item, idx) => {
    const label = document.createElement('label');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = currentValues[idx];
    if (cb.checked) label.classList.add('checked');
    cb.addEventListener('change', () => {
      currentValues[idx] = cb.checked;
      label.classList.toggle('checked', cb.checked);

    // ğŸ¯ Gá»ŒI TALOS NGAY KHI TICK/Bá» TICK
    talosReply("Checklist má»¥c: " + item + " vá»«a " + (cb.checked ? "Ä‘Æ°á»£c tick âœ…" : "bá» tick âŒ"))
      .then(reply => {
        document.getElementById("talos-messages").innerHTML += 
          "<div style='margin:5px 0; padding:5px; background:#f7f7f7; border-radius:4px;'>" + reply + "</div>";
      });

// ğŸ¬ Cinematic: rung nháº¹ khi tick
  if (cb.checked) {
    label.style.transform = "scale(1.05)";
    setTimeout(() => label.style.transform = "scale(1)", 150);
  }

      const safeDate = getSelectedDate().replace(/\//g,"-");
localStorage.setItem(`progress_${group}_${getSafeDate()}`, JSON.stringify(currentValues));
      // Kiá»ƒm tra láº¡i sá»‘ lÆ°á»£ng tick sau khi thay Ä‘á»•i
      let anyCheckedNow = currentValues.some(Boolean);
      updateChainHighlight(item, cb.checked, anyCheckedNow);
      updateChecklistSummary(group, items, currentValues, anyCheckedNow);
      recalcStatsForCurrentGroup(); // luÃ´n tÃ­nh láº¡i tá»•ng bar cho toÃ n bá»™ checklist
      syncCompareChart(); // âœ… láº¯ng nghe tick checklist ngay khi render xong
    });
    label.appendChild(cb);
    label.append(' ' + item);
    checklistDiv.appendChild(label);
  });
  updateChecklistSummary(group, items, currentValues, anyChecked);
  recalcStatsForCurrentGroup(); // luÃ´n tÃ­nh láº¡i tá»•ng bar cho toÃ n bá»™ checklist
}

// --- Khi tick checklist ---
function onChecklistToggle(item, checked, group, idx, label) {
  // KhÃ´ng cá»™ng trá»±c tiáº¿p vÃ o stats, chá»‰ lÆ°u tráº¡ng thÃ¡i, recalcStatsForCurrentGroup sáº½ tÃ­nh láº¡i
  fadeSnippet(storyBank[Math.floor(Math.random() * storyBank.length)]);
  updateChainHighlight(item, checked);
  const progress = JSON.parse(localStorage.getItem('progress_' + group + '_' + getSelectedDate().replace(/\//g,"-") ) || '[]');
  if (progress.length && progress.every(v => v)) {
    showMilestone(milestoneBank[Math.floor(Math.random() * milestoneBank.length)]);
  }
    // ğŸ¬ Cinematic: highlight bar khi hoÃ n thÃ nh háº¿t checklist
    document.querySelectorAll('.fill').forEach(bar => {
      bar.style.boxShadow = "0 0 20px rgba(255,255,255,0.8)";
      setTimeout(()=> bar.style.boxShadow = "none", 600);
    });
syncCompareChart();  // âœ… má»—i láº§n render checklist thÃ¬ Ä‘á»“ng bá»™ chart
}

// --- Äá»“ng bá»™ checklist summary ---
function updateChecklistSummary(group, items, values, anyChecked) {
  const count = values.filter(Boolean).length;
  const total = items.length;
  const rank = getRank(count, total);
  const motivation = getMotivation(rank);
  updateSummary(count, total, rank, motivation, anyChecked);
  // KhÃ´ng gá»i saveHistory ná»¯a vÃ¬ Ä‘Ã£ xÃ³a báº£ng thÃ nh tá»±u
}

// --- Cáº­p nháº­t vÃ¹ng summary ---
function updateSummary(count, total, rank, motivation, anyChecked) {
  document.getElementById('count').textContent = count;
  document.getElementById('total').textContent = total;
  // Äá»™ng lá»±c ná»•i báº­t dÆ°á»›i cÃ¹ng
  const motivationBox = document.getElementById('motivationBox');
  const motivationSpan = document.getElementById('motivation');
  if (anyChecked) {
    motivationBox.style.display = '';
    motivationSpan.textContent = motivation;
    motivationSpan.style.opacity = 0;
    setTimeout(() => {
      motivationSpan.style.opacity = 1;
      motivationSpan.style.transform = "scale(1.08)";
      setTimeout(() => { motivationSpan.style.transform = "scale(1)"; }, 200);
    }, 80);
  } else {
    motivationBox.style.display = 'none';
    motivationSpan.textContent = '';
  }
  // KhÃ´ng cáº§n cáº­p nháº­t ngÃ y/xáº¿p loáº¡i ná»¯a
}

// --- Xáº¿p loáº¡i ---
function getRank(count, total) {
  if (total === 0) return "ChÆ°a xÃ¡c Ä‘á»‹nh";
  const ratio = count / total;
  if (ratio === 1) return "Xuáº¥t sáº¯c";
  if (ratio >= 0.8) return "Tá»‘t";
  if (ratio >= 0.5) return "Trung bÃ¬nh";
  if (ratio > 0) return "Cáº§n cá»‘ gáº¯ng";
  return "ChÆ°a lÃ m";
}

// --- Äá»™ng lá»±c ---
function getMotivation(rank) {
  switch(rank) {
    case "Xuáº¥t sáº¯c": return "Tuyá»‡t vá»i! Báº¡n Ä‘Ã£ hoÃ n thÃ nh xuáº¥t sáº¯c checklist hÃ´m nay!";
    case "Tá»‘t": return "Ráº¥t tá»‘t! HÃ£y cá»‘ gáº¯ng thÃªm Ä‘á»ƒ Ä‘áº¡t má»©c xuáº¥t sáº¯c.";
    case "Trung bÃ¬nh": return "Báº¡n Ä‘ang Ä‘i Ä‘Ãºng hÆ°á»›ng, tiáº¿p tá»¥c phÃ¡t huy nhÃ©!";
    case "Cáº§n cá»‘ gáº¯ng": return "Äá»«ng bá» cuá»™c, hÃ£y thá»­ láº¡i vÃ o ngÃ y mai!";
    case "ChÆ°a lÃ m": return "Báº¯t Ä‘áº§u tá»«ng bÆ°á»›c nhá», báº¡n sáº½ lÃ m Ä‘Æ°á»£c!";
    default: return "";
  }
}

// --- Khá»Ÿi táº¡o ---
document.addEventListener('DOMContentLoaded', function() {
  if (window.Choices) {
    choicesInstance = new Choices(categorySelect, { removeItemButton: true });
    categorySelect.addEventListener('change', handleCategoryChange);
  } else {
    categorySelect.addEventListener('change', handleCategoryChange);
  }
  // Hiá»ƒn thá»‹ lá»‹ch báº±ng flatpickr, luÃ´n hiá»‡n
  if (window.flatpickr) {
    flatpickr("#datePicker", {
      dateFormat: "d/m/Y",
      defaultDate: new Date(),
      allowInput: true,
      clickOpens: true,
      onReady: function(selectedDates, dateStr, instance) {
        // KhÃ´ng tá»± Ä‘á»™ng má»Ÿ lá»‹ch, chá»‰ má»Ÿ khi click
      },
      onChange: function(selectedDates, dateStr) {
        document.getElementById('date').textContent = dateStr;
        // Reset thanh bar khi Ä‘á»•i ngÃ y
        stats.energy = 0; stats.mood = 0; stats.aura = 0;
        saveStats();
        updateBars();
        // Reset táº¥t cáº£ checklist Ä‘Ã£ tick cho ngÃ y má»›i
        Object.keys(checklistData).forEach(group => {
          localStorage.removeItem('progress_' + group);
        });
        if (currentGroup) renderChecklist(currentGroup);
      }
    });
  }
  // Äáº£m báº£o luÃ´n cÃ³ ngÃ y hiá»ƒn thá»‹
  if (!document.getElementById('date').textContent) {
    document.getElementById('date').textContent = getSelectedDate().replace(/\//g,"-") ;
  }
  loadStats();
  // KhÃ´ng gá»i renderHistoryTable ná»¯a
});

// --- CÃ¡c nÃºt chá»©c nÄƒng ---
function triggerImport() {
  document.getElementById('import-file').click();
}
function undoChange() {
  if (currentGroup) {
    localStorage.removeItem('progress_' + currentGroup + '_' + getSafeDate());
    renderChecklist(currentGroup);
  }
}

// --- Sá»± kiá»‡n chá»n nhÃ³m checklist (KHÃ”I PHá»¤C logic báº£ng so sÃ¡nh khi chá»n nhiá»u nhÃ³m) ---
function handleCategoryChange() {
  if (window.Choices && choicesInstance) {
    selectedGroups = choicesInstance.getValue(true);
    if (selectedGroups.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = selectedGroups[0];
      renderChecklist(currentGroup);
    } else if (selectedGroups.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(selectedGroups);
      updateSummary(0, 0, "ChÆ°a xÃ¡c Ä‘á»‹nh", "");
      // Reset thanh bar khi chá»n nhiá»u nhÃ³m
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "ChÆ°a xÃ¡c Ä‘á»‹nh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  } else {
    // fallback cho select thÆ°á»ng
    const values = Array.from(categorySelect.selectedOptions).map(opt => opt.value).filter(Boolean);
    if (values.length === 1) {
      document.getElementById('compareChart').classList.add('hidden');
      currentGroup = values[0];
      renderChecklist(currentGroup);
    } else if (values.length > 1) {
      document.getElementById('compareChart').classList.remove('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      document.getElementById('snippet').textContent = '';
      currentGroup = null;
      renderCompareChart(values);
      updateSummary(0, 0, "ChÆ°a xÃ¡c Ä‘á»‹nh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    } else {
      document.getElementById('compareChart').classList.add('hidden');
      document.getElementById('checklist-form').innerHTML = '';
      currentGroup = null;
      updateSummary(0, 0, "ChÆ°a xÃ¡c Ä‘á»‹nh", "");
      stats.energy = 0; stats.mood = 0; stats.aura = 0;
      updateBars();
    }
  }
}

// --- Biá»ƒu Ä‘á»“ so sÃ¡nh khi chá»n nhiá»u nhÃ³m checklist ---
function renderCompareChart(groups) {
  const chartElem = document.getElementById('compareChart');
  chartElem.classList.remove('hidden');
  // Clear canvas before drawing new chart
  chartElem.width = chartElem.width;
  const ctx = chartElem.getContext('2d');
  const labels = groups.map(getGroupName);
  const completed = groups.map(g => {
    const items = checklistData[g] || [];
    const values = JSON.parse(localStorage.getItem('progress_' + g + '_' + getSelectedDate().replace(/\//g,"-") ) || '[]');
    return values.filter(Boolean).length;
  });
  const totals = groups.map(g => (checklistData[g] || []).length);

  if (compareChart) compareChart.destroy();
  compareChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'HoÃ n thÃ nh',
          data: completed,
          backgroundColor: '#4caf50'
        },
        {
          label: 'Tá»•ng má»¥c',
          data: totals,
          backgroundColor: '#c8e6c9'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        datalabels: { anchor: 'end', align: 'top' }
      },
      scales: {
        y: { beginAtZero: true, precision: 0 }
      }
    }
  });
}

// --- Helper: láº¥y tÃªn nhÃ³m checklist ---
function getGroupName(key) {
  const map = {
    chamCoThe: "ChÄƒm CÆ¡ Thá»ƒ",
    chamNhaCua: "ChÄƒm NhÃ  Cá»­a",
    dinhDuong: "Dinh DÆ°á»¡ng",
    langPhi: "Kiá»ƒm SoÃ¡t LÃ£ng PhÃ­",
    aura: "NÃ¢ng Táº§ng Aura",
    soThich: "Sá»Ÿ ThÃ­ch",
    theDuc: "Thá»ƒ Dá»¥c"
  };
  return map[key] || key;
}

// === HÃ€M Má»šI: render dá»¯ liá»‡u vÃ o báº£ng lá»‹ch sá»­ ===
function renderHistoryTable() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  const allKeys = Object.keys(localStorage).filter(k => k.startsWith("progress_"));

  if (allKeys.length === 0) {
    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:#888;'>ChÆ°a cÃ³ dá»¯ liá»‡u</td></tr>";
    return;
    document.getElementById("historyModalContent").style.paddingBottom = "16px";
  }

  allKeys.forEach(key => {
    const parts = key.replace("progress_", "").split("_");
    const group = parts[0];
    const date = parts.slice(1).join("_");

    const ticks = JSON.parse(localStorage.getItem(key) || "[]");
    const items = checklistData[group] || [];
    const completed = ticks.filter(Boolean).length;
    const total = items.length;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td>${completed}/${total}</td>
      <td>${items.map((item, idx) => ticks[idx] ? "âœ… " + item : "âŒ " + item).join("<br>")}</td>
      <td>
        <button class="delete-row" data-key="${key}"
    style="background:#e53935; color:#fff; border:none; border-radius:6px;
    padding:4px 10px; cursor:pointer; font-weight:bold;">
    ğŸ—‘
  </button>
</td>
    `;
    tbody.appendChild(tr);
  });

  // ğŸ‘‰ Gáº¯n sá»± kiá»‡n xÃ³a cho táº¥t cáº£ nÃºt delete-row
  document.querySelectorAll(".delete-row").forEach(btn => {
    btn.addEventListener("click", function() {
      const key = this.getAttribute("data-key");
      if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a dá»¯ liá»‡u ngÃ y nÃ y khÃ´ng?")) {
        localStorage.removeItem(key);
        renderHistoryTable();    // refresh báº£ng
        renderEmotionFlow();     // refresh biá»ƒu Ä‘á»“ sau xÃ³a
      }
    });
  });
}

// === Táº O INSIGHT CHO BOX #historyHighlight ===
function updateHistoryHighlight() {
  const highlightBox = document.getElementById("historyHighlight");
  const rows = document.querySelectorAll("#historyTable tbody tr");
  
  if (!rows.length || rows[0].innerText.includes("ChÆ°a cÃ³ dá»¯ liá»‡u")) {
    highlightBox.innerHTML = "âŒ ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ thá»‘ng kÃª.";
    return;
  }

  let total = 0, done = 0, bestDay = "", bestScore = 0;

  rows.forEach(row => {
    const date = row.querySelector("td").innerText;
    const tick = row.querySelector("td:nth-child(2)").innerText.split("/");
    const doneToday = parseInt(tick[0]);
    const totalToday = parseInt(tick[1]);
    done += doneToday;
    total += totalToday;
    if (doneToday > bestScore) {
      bestScore = doneToday;
      bestDay = date;
    }
  });

  const percent = Math.round((done/total)*100);
  highlightBox.innerHTML =
    `ğŸ“Š <b>${done}/${total}</b> má»¥c Ä‘Ã£ hoÃ n thÃ nh (${percent}%).<br>
     ğŸ† NgÃ y tá»‘t nháº¥t: <b>${bestDay}</b> (${bestScore} má»¥c tick)`;
}

function renderEmotionFlow() {
const ctx = document.getElementById("emotionFlowChart").getContext("2d");
const chartType = document.getElementById("chartType") 
  ? document.getElementById("chartType").value 
  : "line";
const scaleMode = document.getElementById("flowScale") 
  ? document.getElementById("flowScale").value 
  : "daily";
  const showEnergy = document.getElementById("toggleEnergy")?.checked ?? true;
  const showMood   = document.getElementById("toggleMood")?.checked ?? true;
  const showAura   = document.getElementById("toggleAura")?.checked ?? true;

  const allKeys = Object.keys(localStorage).filter(k => k.startsWith("progress_"));
  if (allKeys.length === 0) {
    ctx.font = "16px Arial";
    ctx.fillText("âŒ ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ váº½ Emotion Flow", 10, 50);
  document.getElementById("emotionFlowChart").style.display = "none";
    return;
  }

  // Gom dá»¯ liá»‡u thÃ´ theo ngÃ y
  const rawDailyStats = {};
  allKeys.forEach(key => {
    const parts = key.replace("progress_", "").split("_");
    const group = parts[0];
    const date = parts.slice(1).join("_");
    const ticks = JSON.parse(localStorage.getItem(key) || "[]");
    const items = checklistData[group] || [];

    items.forEach((item, idx) => {
      if (ticks[idx]) {
        const val = checklistValues[item] || { energy: 0, mood: 0, aura: 0 };
        if (!rawDailyStats[date]) rawDailyStats[date] = { energy: 0, mood: 0, aura: 0 };
        rawDailyStats[date].energy += val.energy;
        rawDailyStats[date].mood += val.mood;
        rawDailyStats[date].aura += val.aura;
      }
    });
  // ğŸ“Š Sau khi váº½ xong chart, update Insight Box báº±ng dá»¯ liá»‡u cá»§a chÃ­nh hÃ m nÃ y
  const insightBox = document.getElementById("historyHighlight");
  if (insightBox) {
    insightBox.innerHTML = generateInsights(rawDailyStats);
  }
  });

  // HÃ m parse date
  function parseDate(dateStr) {
    const [d,m,y] = dateStr.split("/").map(Number);
    return new Date(y, m-1, d);
  }

  // Gom dá»¯ liá»‡u theo scale
  const statsByScale = {};
  Object.keys(rawDailyStats).forEach(date => {
    const d = parseDate(date);
    let key;
    if (scaleMode === "weekly") {
      const firstDay = new Date(d);
      const day = d.getDay() || 7;
      firstDay.setDate(d.getDate() - day + 1);
      key = `Tuáº§n ${firstDay.getDate()}/${firstDay.getMonth()+1}`;
    } else if (scaleMode === "monthly") {
      key = `${d.getMonth()+1}/${d.getFullYear()}`;
    } else {
      key = date;
    }

    if (!statsByScale[key]) statsByScale[key] = { energy: 0, mood: 0, aura: 0 };
    statsByScale[key].energy += rawDailyStats[date].energy;
    statsByScale[key].mood += rawDailyStats[date].mood;
    statsByScale[key].aura += rawDailyStats[date].aura;
  });

  // Sort labels
  const labels = Object.keys(statsByScale).sort((a,b)=>{
    if (scaleMode === "daily") {
      const [da,ma,ya] = a.split("/").map(Number);
      const [db,mb,yb] = b.split("/").map(Number);
      return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
    }
    const numA = parseInt(a.split("/")[1] || 0);
    const numB = parseInt(b.split("/")[1] || 0);
    return numA - numB;
  });

  const energyData = labels.map(d => statsByScale[d].energy);
  const moodData   = labels.map(d => statsByScale[d].mood);
  const auraData   = labels.map(d => statsByScale[d].aura);

  // XoÃ¡ chart cÅ©
  if (window.emotionChart) window.emotionChart.destroy();

// ğŸ¨ Gradient mÃ u cho Energy/Mood/Aura
const gradientEnergy = ctx.createLinearGradient(0, 0, 0, 250);
gradientEnergy.addColorStop(0, "rgba(255, 215, 0, 0.6)");
gradientEnergy.addColorStop(1, "rgba(255, 255, 153, 0.2)");

const gradientMood = ctx.createLinearGradient(0, 0, 0, 250);
gradientMood.addColorStop(0, "rgba(77, 182, 226, 0.6)");
gradientMood.addColorStop(1, "rgba(179, 229, 252, 0.2)");

const gradientAura = ctx.createLinearGradient(0, 0, 0, 250);
gradientAura.addColorStop(0, "rgba(179, 136, 235, 0.6)");
gradientAura.addColorStop(1, "rgba(233, 215, 254, 0.2)");

  // Build dataset Ä‘á»™ng theo toggle
  const datasets = [];
  if (showEnergy) {
  datasets.push({
    label: "âš¡ Energy",
    data: energyData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientEnergy : "rgba(255,215,0,0.5)",
    borderColor: "#FFD700",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}
if (showMood) {
  datasets.push({
    label: "ğŸ˜Š Mood",
    data: moodData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientMood : "rgba(77,182,226,0.5)",
    borderColor: "#4DB6E2",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}
if (showAura) {
  datasets.push({
    label: "âœ¨ Aura",
    data: auraData,
    fill: chartType === "line",
    backgroundColor: chartType === "line" ? gradientAura : "rgba(179,136,235,0.5)",
    borderColor: "#B388EB",
    tension: 0.4,
    stack: chartType === "bar" ? "stack1" : undefined
  });
}

  // Render chart
  document.getElementById("emotionFlowChart").style.display = "block";
  window.emotionChart = new Chart(ctx, {
    type: chartType,
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
scales: (chartType === "radar") ? {} : {
  x: { stacked: chartType === "bar", title: { display: true, text: scaleMode === "daily" ? "NgÃ y" : (scaleMode === "weekly" ? "Tuáº§n" : "ThÃ¡ng") }},
  y: { stacked: chartType === "bar", beginAtZero: true, title: { display: true, text: "Äiá»ƒm" }}
      }
    }
  });
  // ğŸ¬ Cinematic: Chart fade-in khi render xong
const chartCanvas = document.getElementById("emotionFlowChart");

// reset Ä‘á»ƒ láº§n render má»›i cÃ³ hiá»‡u á»©ng fade
chartCanvas.classList.remove("chart-loaded");
setTimeout(() => chartCanvas.classList.add("chart-loaded"), 50);
}

function generateInsights(rawDailyStats) {
  const dates = Object.keys(rawDailyStats).sort((a,b) => {
    const [da,ma,ya] = a.split("/").map(Number);
    const [db,mb,yb] = b.split("/").map(Number);
    return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
  });

  if (dates.length === 0) return "âŒ KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ nháº­n xÃ©t.";

  let insights = [];

  // ğŸ“Š TÃ¬m ngÃ y cao nháº¥t & tháº¥p nháº¥t cho tá»«ng chá»‰ sá»‘
  let maxEnergy = { date: "", value: -Infinity };
  let minEnergy = { date: "", value: Infinity };
  let maxMood = { date: "", value: -Infinity };
  let minMood = { date: "", value: Infinity };
  let maxAura = { date: "", value: -Infinity };
  let minAura = { date: "", value: Infinity };

  dates.forEach(date => {
    const stats = rawDailyStats[date];
    if (stats.energy > maxEnergy.value) { maxEnergy = { date, value: stats.energy }; }
    if (stats.energy < minEnergy.value) { minEnergy = { date, value: stats.energy }; }
    if (stats.mood > maxMood.value) { maxMood = { date, value: stats.mood }; }
    if (stats.mood < minMood.value) { minMood = { date, value: stats.mood }; }
    if (stats.aura > maxAura.value) { maxAura = { date, value: stats.aura }; }
    if (stats.aura < minAura.value) { minAura = { date, value: stats.aura }; }
  });

  insights.push(`ğŸ“† <b>${maxMood.date}</b> lÃ  ngÃ y <b>Mood</b> cao nháº¥t (${maxMood.value} Ä‘iá»ƒm).`);
  insights.push(`âœ¨ <b>${maxAura.date}</b> cÃ³ <b>Aura</b> sÃ¡ng nháº¥t (${maxAura.value} Ä‘iá»ƒm).`);
  insights.push(`âš¡ <b>${maxEnergy.date}</b> Ä‘áº¡t <b>Energy</b> Ä‘á»‰nh (${maxEnergy.value} Ä‘iá»ƒm).`);

  // ğŸ“‰ Kiá»ƒm tra biáº¿n Ä‘á»™ng
  let drops = [];
  for (let i = 1; i < dates.length; i++) {
    const prev = rawDailyStats[dates[i-1]];
    const curr = rawDailyStats[dates[i]];

    if (prev.energy - curr.energy >= 5) {
      drops.push(`âš¡ Energy giáº£m máº¡nh ${prev.energy - curr.energy} Ä‘iá»ƒm vÃ o ngÃ y ${dates[i]}.`);
    }
    if (prev.mood - curr.mood >= 5) {
      drops.push(`ğŸ˜Š Mood tá»¥t ${prev.mood - curr.mood} Ä‘iá»ƒm vÃ o ngÃ y ${dates[i]}.`);
    }
    if (prev.aura - curr.aura >= 5) {
      drops.push(`âœ¨ Aura má» Ä‘i ${prev.aura - curr.aura} Ä‘iá»ƒm vÃ o ngÃ y ${dates[i]}.`);
    }
  }

  if (drops.length > 0) {
    insights.push("<br><b>âš  Biáº¿n Ä‘á»™ng Ä‘Ã¡ng chÃº Ã½:</b><br>" + drops.join("<br>"));
  } else {
    insights.push("<br>âœ… KhÃ´ng cÃ³ biáº¿n Ä‘á»™ng lá»›n â€“ tráº¡ng thÃ¡i khÃ¡ á»•n Ä‘á»‹nh.");
  }

  return insights.join("<br>");
}

document.addEventListener("DOMContentLoaded", () => {
  const flowScaleSelect = document.getElementById("flowScale");
  if (flowScaleSelect) {
    flowScaleSelect.addEventListener("change", renderEmotionFlow);
  }

  const chartTypeSelect = document.getElementById("chartType");
  if (chartTypeSelect) {
    chartTypeSelect.addEventListener("change", renderEmotionFlow);
  }

  ["toggleEnergy","toggleMood","toggleAura"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", renderEmotionFlow);
  });
});

function syncCompareChart() {
  // Láº¯ng nghe tick checklist á»Ÿ cháº¿ Ä‘á»™ 1 nhÃ³m vÃ  update chart náº¿u Ä‘ang má»Ÿ multi-chart
  document.querySelectorAll('#checklist-form input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      if (selectedGroups.length > 1) {
        renderCompareChart(selectedGroups);
      }
    });
  });
}

  // --- Dá»¯ liá»‡u File JSON ---
function exportDataJSON() {
  let data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("progress_") || key === "simStats") { 
      data[key] = JSON.parse(localStorage.getItem(key));
    }
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "checklist-data.json";
  link.click();
}
</script>

<script>
const OPENAI_API_KEY = "...";   // â† dÃ¡n API key GPT cá»§a em vÃ o Ä‘Ã¢y


let lastCall = 0;

async function talosReply(userMessage) {
  // ğŸ‘‰ Táº M Dá»ªNG API (comment toÃ n bá»™ fetch):
  // const response = await fetch("https://api.openai.com/v1/chat/completions", {
  //   method: "POST",
  //   headers: {
  //     "Content-Type": "application/json",
  //     "Authorization": "Bearer " + OPENAI_API_KEY
  //   },
  //   body: JSON.stringify({
  //     model: "gpt-3.5-turbo",
  //     messages: [
  //       { role: "system", content: "Báº¡n lÃ  Talos..." },
  //       { role: "user", content: userMessage }
  //     ]
  //   })
  // });

  // const data = await response.json();
  // if (!data.choices || !data.choices[0]) {
  //   console.error("API Error:", data);
  //   return "âš ï¸ API bá»‹ quÃ¡ táº£i hoáº·c key Ä‘ang bá»‹ giá»›i háº¡n (429). Em thá»­ tick cháº­m hÆ¡n hoáº·c Ä‘á»•i model nhÃ©.";
  // }

  // ğŸ‘‰ TRáº¢ Lá»œI GIáº¢ Láº¬P
  return "ğŸ¤– [Táº M Dá»ªNG API] Talos Coach chÆ°a káº¿t ná»‘i GPT. Tick checklist váº«n ghi nháº­n.";
}

</script>
<!-- 
<div id="talos-chat" style="
     position: fixed;
     bottom: 20px;
     right: 20px;
     width: 300px;
     height: 400px;
     background: #fff;
     border: 1px solid #ccc;
     border-radius: 8px;
     box-shadow: 0 2px 8px rgba(0,0,0,0.2);
     overflow-y: auto;
     padding: 10px;
     font-family: Arial, sans-serif;">
   <strong>Talos Coach</strong>
   <div id="talos-messages"></div>
</div>-->
</body>
</html>
